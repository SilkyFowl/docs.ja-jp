---
description: '詳細情報: バージョン 3.5 SP1 における HttpWebRequest の NTLM 認証への変更'
title: バージョン 3.5 SP1 における HttpWebRequest の NTLM 認証への変更
ms.date: 03/30/2017
ms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a
ms.openlocfilehash: cdb17317dbafc167cce7a9b2785be68a35d3bd5b
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99791635"
---
# <a name="changes-to-ntlm-authentication-for-httpwebrequest-in-version-35-sp1"></a><span data-ttu-id="81c16-103">バージョン 3.5 SP1 における HttpWebRequest の NTLM 認証への変更</span><span class="sxs-lookup"><span data-stu-id="81c16-103">Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1</span></span>

<span data-ttu-id="81c16-104">セキュリティの変更は、System.Net 名前空間の <xref:System.Net.HttpWebRequest>、<xref:System.Net.HttpListener>、<xref:System.Net.Security.NegotiateStream>、および関連クラスによる統合 Windows 認証の処理方法に影響を与える、.NET Framework Version 3.5 SP1 以降で行われました。</span><span class="sxs-lookup"><span data-stu-id="81c16-104">Security changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream>, and related classes in the System.Net namespace.</span></span> <span data-ttu-id="81c16-105">これらの変更は、これらのクラスを使用して Web 要求を作成し、NTLM に基づく統合 Windows 認証が使用されている応答を受信するアプリケーションに影響を及ぼす場合があります。</span><span class="sxs-lookup"><span data-stu-id="81c16-105">These changes can affect applications that use these classes to make web requests and receive responses where integrated Windows authentication based on NTLM is used.</span></span> <span data-ttu-id="81c16-106">この変更は、統合 Windows 認証を使用するように構成されている Web サーバーおよびクライアント アプリケーションに影響を与える可能性があります。</span><span class="sxs-lookup"><span data-stu-id="81c16-106">This change can impact web servers and client applications that are configured to use integrated Windows authentication.</span></span>

## <a name="overview"></a><span data-ttu-id="81c16-107">概要</span><span class="sxs-lookup"><span data-stu-id="81c16-107">Overview</span></span>

<span data-ttu-id="81c16-108">統合 Windows 認証の設計では、一部の資格情報の応答をユニバーサルにすることを許可しています。つまり、これらを再利用または転送することができます。</span><span class="sxs-lookup"><span data-stu-id="81c16-108">The design of integrated Windows authentication allows for some credential responses to be universal, meaning they can be re-used or forwarded.</span></span> <span data-ttu-id="81c16-109">この設計機能が特に必要ではない場合は、認証プロトコルで、ターゲット固有の情報とチャネル固有の情報を伝達する必要があります。</span><span class="sxs-lookup"><span data-stu-id="81c16-109">If this particular design feature is not needed, then the authentication protocols should carry target specific information as well as channel specific information.</span></span> <span data-ttu-id="81c16-110">これによりサービスは拡張保護を提供して、資格情報の応答にサービス プリンシパル名 (SPN) などのサービス固有の情報が確実に含まれるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="81c16-110">Services can then provide extended protection to ensure that credential responses contain service specific information such as a Service Principal Name (SPN).</span></span> <span data-ttu-id="81c16-111">資格情報の交換でこの情報を使用すると、不適切に使用されている可能性がある資格情報の応答の不適切な取得に対してサービスの保護を強化することができます。</span><span class="sxs-lookup"><span data-stu-id="81c16-111">With this information in the credential exchanges, services are able to better protect against malicious use of credential responses that might have been improperly obtained.</span></span>

<span data-ttu-id="81c16-112"><xref:System.Net> 名前空間と <xref:System.Net.Security> 名前空間内の複数のコンポーネントは、呼び出し元のアプリケーションに代わって統合 Windows 認証を実行します。</span><span class="sxs-lookup"><span data-stu-id="81c16-112">Multiple components in the <xref:System.Net> and <xref:System.Net.Security> namespaces perform integrated Windows authentication on behalf of a calling application.</span></span> <span data-ttu-id="81c16-113">このセクションでは、統合 Windows 認証の使用で拡張保護を追加するための System.Net コンポーネントへの変更について説明します。</span><span class="sxs-lookup"><span data-stu-id="81c16-113">This section describes changes to System.Net components to add extended protection in their use of integrated Windows authentication.</span></span>

## <a name="changes"></a><span data-ttu-id="81c16-114">[変更点]</span><span class="sxs-lookup"><span data-stu-id="81c16-114">Changes</span></span>

<span data-ttu-id="81c16-115">統合 Windows 認証で使用される NTLM 認証プロセスには、クライアント コンピューターに送り返される、ターゲット コンピューターによって発行されるチャレンジが含まれています。</span><span class="sxs-lookup"><span data-stu-id="81c16-115">The NTLM authentication process used with integrated Windows authentication includes a challenge issued by the destination computer and sent back to the client computer.</span></span> <span data-ttu-id="81c16-116">コンピューター自体が生成したチャレンジをコンピューターが受け取った場合、接続がループ バック接続 (たとえば、IPv4 アドレス 127.0.0.1) でない限り、認証は失敗します。</span><span class="sxs-lookup"><span data-stu-id="81c16-116">When a computer receives a challenge it generated itself, the authentication will fail unless the connection is a loop back connection (IPv4 address 127.0.0.1, for example).</span></span>

<span data-ttu-id="81c16-117">内部 Web サーバー上で実行されているサービスにアクセスする場合、`http://contoso/service` や `https://contoso/service` のような URL を使用してサービスにアクセスするのが一般的です。</span><span class="sxs-lookup"><span data-stu-id="81c16-117">When accessing a service running on an internal Web server, it is common to access the service using a URL similar to `http://contoso/service` or `https://contoso/service`.</span></span> <span data-ttu-id="81c16-118">"contoso" という名前は、多くの場合、サービスが展開されているコンピューターの名前ではありません。</span><span class="sxs-lookup"><span data-stu-id="81c16-118">The name "contoso" is often not the computer name of the computer on which the service is deployed.</span></span> <span data-ttu-id="81c16-119"><xref:System.Net> と関連する名前空間は、名前をアドレスに解決するために、Active Directory、DNS、NetBIOS、ローカル コンピューターのホスト ファイル (通常は WINDOWS\system32\drivers\etc\hosts など)、またはローカル コンピューターの lmhosts ファイル名 (通常は WINDOWS\system32\drivers\etc\lmhosts など) の使用をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="81c16-119">The <xref:System.Net> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\system32\drivers\etc\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\system32\drivers\etc\lmhosts, for example) to resolve names to addresses.</span></span> <span data-ttu-id="81c16-120">"contoso" という名前は、"contoso" に送信された要求が適切なサーバー コンピューターに送信されるように解決されます。</span><span class="sxs-lookup"><span data-stu-id="81c16-120">The name "contoso" is resolved so that requests sent to "contoso" are sent to the appropriate server computer.</span></span>

<span data-ttu-id="81c16-121">大規模な展開用に構成されている場合、クライアント アプリケーションとエンド ユーザーが使用しない基礎のコンピューター名に単一の仮想サーバー名を展開に指定することも一般的です。</span><span class="sxs-lookup"><span data-stu-id="81c16-121">When configured for large deployments, it is also common for a single virtual server name to be given to the deployment with the underlying machine names never used by client applications and end users.</span></span> <span data-ttu-id="81c16-122">たとえば、サーバー `www.contoso.com` を呼び出しても、内部ネットワークでは単に "contoso" を使用することがあります。</span><span class="sxs-lookup"><span data-stu-id="81c16-122">For example, you might call the server `www.contoso.com`, but on an internal network simply use "contoso".</span></span> <span data-ttu-id="81c16-123">この名前は、クライアント Web 要求で Host ヘッダーと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="81c16-123">This name is called the Host header in the client web request.</span></span> <span data-ttu-id="81c16-124">HTTP プロトコルの指定に従い、Host 要求ヘッダー フィールドは、要求されているリソースのインターネット ホストとポート番号を指定します。</span><span class="sxs-lookup"><span data-stu-id="81c16-124">As specified by the HTTP protocol, the Host request-header field specifies the Internet host and port number of the resource being requested.</span></span> <span data-ttu-id="81c16-125">この情報は、ユーザーまたは参照リソース (HTTP URL で生成されるもの) に指定された元の URI から取得されます。</span><span class="sxs-lookup"><span data-stu-id="81c16-125">This information is obtained from the original URI given by the user or referring resource (generally an HTTP URL).</span></span> <span data-ttu-id="81c16-126">.NET Framework Version 4 では、この情報は、新しい <xref:System.Net.HttpWebRequest.Host%2A> プロパティを使用して設定することもできます。</span><span class="sxs-lookup"><span data-stu-id="81c16-126">On .NET Framework version 4, this information can also be set by the client using the new <xref:System.Net.HttpWebRequest.Host%2A> property.</span></span>

<span data-ttu-id="81c16-127"><xref:System.Net.AuthenticationManager> クラスは、<xref:System.Net.WebRequest> 派生クラスと <xref:System.Net.WebClient> クラスが使用するマネージド認証コンポーネント ("モジュール") を制御します。</span><span class="sxs-lookup"><span data-stu-id="81c16-127">The <xref:System.Net.AuthenticationManager> class controls the managed authentication components ("modules") that are used by <xref:System.Net.WebRequest> derivative classes and the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="81c16-128"><xref:System.Net.AuthenticationManager> クラスは、<xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> オブジェクトを公開するプロパティを提供します。このオブジェクトは、URI 文字列でインデックスが作成され、認証中に使用されるカスタム SPN 文字列をアプリケーションが提供するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="81c16-128">The <xref:System.Net.AuthenticationManager> class provides a property that exposes a <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication.</span></span>

<span data-ttu-id="81c16-129">Version 3.5 SP1 の既定では、<xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> プロパティが設定されていない場合、NTLM (NT LAN マネージャー) 認証交換の SPN の要求 URL で使用されたホスト名を指定します。</span><span class="sxs-lookup"><span data-stu-id="81c16-129">Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> property is not set.</span></span> <span data-ttu-id="81c16-130">要求 URL で使用されたホスト名は、クライアント要求の <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> に指定された Host ヘッダーとは異なる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="81c16-130">The host name used in the request URL may be different from the Host header specified in the <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> in the client request.</span></span> <span data-ttu-id="81c16-131">要求 URL に使用されているホスト名は、サーバーの実際のホスト名、サーバーのコンピューター名、コンピューターの IP アドレス、またはループバック アドレスとは異なる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="81c16-131">The host name used in the request URL may be different from the actual host name of the server, the machine name of the server, the computer's IP address, or the loopback address.</span></span> <span data-ttu-id="81c16-132">このような場合、Windows は認証要求に失敗します。</span><span class="sxs-lookup"><span data-stu-id="81c16-132">In these cases, Windows will fail the authentication request.</span></span> <span data-ttu-id="81c16-133">この問題を解決するには、クライアント要求の要求 URL に使用されているホスト名 (たとえば "contoso") が、実際はローカル コンピューターの代替名であると Windows に通知する必要があります。</span><span class="sxs-lookup"><span data-stu-id="81c16-133">To address the issue, we need to notify Windows that the host name used in the request URL in the client request ("contoso", for example) is actually an alternate name for the local computer.</span></span>

<span data-ttu-id="81c16-134">サーバー アプリケーションがこの変更を回避するには、いくつかの方法があります。</span><span class="sxs-lookup"><span data-stu-id="81c16-134">There are several possible methods for a server application to work around this change.</span></span> <span data-ttu-id="81c16-135">推奨されるアプローチは、要求 URL に使用されているホスト名を、サーバーのレジストリ内の `BackConnectionHostNames` キーにマップすることです。</span><span class="sxs-lookup"><span data-stu-id="81c16-135">The recommended approach is to map the host name used in the request URL to the `BackConnectionHostNames` key in the registry on the server.</span></span> <span data-ttu-id="81c16-136">通常、`BackConnectionHostNames` レジストリ キーは、ホスト名をループバック アドレスにマップするために使用されます。</span><span class="sxs-lookup"><span data-stu-id="81c16-136">The `BackConnectionHostNames` registry key is normally used to map a host name to a loopback address.</span></span> <span data-ttu-id="81c16-137">手順は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="81c16-137">The steps are listed below.</span></span>

<span data-ttu-id="81c16-138">ループバック アドレスにマップされているホスト名を指定し、ローカル コンピューター上の Web サイトに接続するには、次の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="81c16-138">To specify the host names that are mapped to the loopback address and can connect to Web sites on a local computer, follow these steps:</span></span>

1. <span data-ttu-id="81c16-139">[スタート] ボタンをクリックし、[ファイル名を指定して実行] をクリックして「regedit」と入力し、[OK] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="81c16-139">Click Start, click Run, type regedit, and then click OK.</span></span>

2. <span data-ttu-id="81c16-140">レジストリ エディターで、次のレジストリ キーを探してクリックします。</span><span class="sxs-lookup"><span data-stu-id="81c16-140">In Registry Editor, locate and then click the following registry key:</span></span>

    `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0`

3. <span data-ttu-id="81c16-141">[MSV1_0] を右クリックし、[新規作成] をポイントし、[複数行文字列値] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="81c16-141">Right-click MSV1_0, point to New, and then click Multi-String Value.</span></span>

4. <span data-ttu-id="81c16-142">「`BackConnectionHostNames`」と入力し、Enter キーを押します。</span><span class="sxs-lookup"><span data-stu-id="81c16-142">Type `BackConnectionHostNames`, and then press ENTER.</span></span>

5. <span data-ttu-id="81c16-143">`BackConnectionHostNames` を右クリックし、[変更] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="81c16-143">Right-click `BackConnectionHostNames`, and then click Modify.</span></span>

6. <span data-ttu-id="81c16-144">[値のデータ] ボックスに、サイトの 1 つまたは複数のホスト名 (要求 URL に使用されているホスト名) を入力し、[OK] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="81c16-144">In the Value data box, type the host name or the host names for the sites (the host name used in the request URL) that are on the local computer, and then click OK.</span></span>

7. <span data-ttu-id="81c16-145">レジストリ エディターを終了し、IISAdmin サービスを再起動して、IISReset を実行します。</span><span class="sxs-lookup"><span data-stu-id="81c16-145">Quit Registry Editor, and then restart the IISAdmin service and run IISReset.</span></span>

<span data-ttu-id="81c16-146"><https://support.microsoft.com/kb/896861> で説明されているように、あまり安全ではない回避策はループ バック チェックを無効にすることです。</span><span class="sxs-lookup"><span data-stu-id="81c16-146">A less secure work around is to disable the loop back check, as described in <https://support.microsoft.com/kb/896861>.</span></span> <span data-ttu-id="81c16-147">これによって、リフレクション攻撃に対する保護が無効になります。</span><span class="sxs-lookup"><span data-stu-id="81c16-147">This disables the protection against reflection attacks.</span></span> <span data-ttu-id="81c16-148">そのため、実際に使用するコンピューターと想定するコンピューターにのみ、代替名のセットを制限することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="81c16-148">So it is better to constrain the set of alternate names to only those you expect the machine to actually use.</span></span>

## <a name="see-also"></a><span data-ttu-id="81c16-149">関連項目</span><span class="sxs-lookup"><span data-stu-id="81c16-149">See also</span></span>

- <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>
- <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType>
- <xref:System.Net.HttpWebRequest.Host%2A?displayProperty=nameWithType>
