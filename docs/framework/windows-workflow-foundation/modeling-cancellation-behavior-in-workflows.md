---
description: 詳細については、「ワークフローでのキャンセル動作のモデリング」を参照してください。
title: ワークフローでの取り消し動作のモデル化
ms.date: 03/30/2017
ms.assetid: d48f6cf3-cdde-4dd3-8265-a665acf32a03
ms.openlocfilehash: 971e044336eb0aed41e773e03f6e0fb70d959094
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99792649"
---
# <a name="modeling-cancellation-behavior-in-workflows"></a><span data-ttu-id="e14bd-103">ワークフローでの取り消し動作のモデル化</span><span class="sxs-lookup"><span data-stu-id="e14bd-103">Modeling Cancellation Behavior in Workflows</span></span>

<span data-ttu-id="e14bd-104">アクティビティは、たとえば <xref:System.Activities.Statements.Parallel> アクティビティを使用して、ワークフロー内部で取り消すことができます。このアクティビティでは、<xref:System.Activities.Statements.Parallel.CompletionCondition%2A> の評価結果が `true` になると、完了していない分岐が取り消されます。また、ホストで <xref:System.Activities.WorkflowApplication.Cancel%2A> を呼び出すと、アクティビティをワークフロー外から取り消すこともできます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-104">Activities can be canceled inside a workflow, for example by a <xref:System.Activities.Statements.Parallel> activity canceling incomplete branches when its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true`, or from outside the workflow, if the host calls <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="e14bd-105">取り消し処理を指定するには、ワークフローの作成者は、<xref:System.Activities.Statements.CancellationScope> アクティビティまたは <xref:System.Activities.Statements.CompensableActivity> アクティビティを使用するか、取り消しロジックを指定するカスタム アクティビティを作成します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-105">To provide cancellation handling, workflow authors can use the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> activity, or create custom activities that provide cancellation logic.</span></span> <span data-ttu-id="e14bd-106">このトピックでは、ワークフローにおける取り消しの概要について説明します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-106">This topic provides an overview of cancellation in workflows.</span></span>  
  
## <a name="cancellation-compensation-and-transactions"></a><span data-ttu-id="e14bd-107">取り消し、補正、およびトランザクション</span><span class="sxs-lookup"><span data-stu-id="e14bd-107">Cancellation, Compensation, and Transactions</span></span>  

 <span data-ttu-id="e14bd-108">アプリケーションでトランザクションを使用すると、トランザクションのプロセスでエラーが発生した場合、トランザクション内で実行されたすべての変更を中止 (ロールバック) できます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-108">Transactions give your application the ability to abort (roll back) all changes executed within the transaction if any errors occur during any part of the transaction process.</span></span> <span data-ttu-id="e14bd-109">ただし、長期間にわたって実行される処理やトランザクション リソースを含まない処理など、取り消す (元に戻す) 必要がある処理によってはトランザクションに適さないものもあります。</span><span class="sxs-lookup"><span data-stu-id="e14bd-109">However, not all work that may need to be canceled or undone is appropriate for transactions, such as long-running work or work that does not involve transactional resources.</span></span> <span data-ttu-id="e14bd-110">補正は、ワークフローでエラーが発生した場合に、前に完了した非トランザクションの処理を元に戻すためのモデルを提供します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-110">Compensation provides a model for undoing previously completed non-transactional work if there is a subsequent failure in the workflow.</span></span> <span data-ttu-id="e14bd-111">取り消しは、完了していない非トランザクションの処理をワークフローやアクティビティの作成者が処理できるようにするためのモデルを提供します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-111">Cancellation provides a model for workflow and activity authors to handle non-transactional work that was not completed.</span></span> <span data-ttu-id="e14bd-112">実行を完了していないアクティビティが取り消された場合、取り消しロジックが指定されていればそのロジックが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-112">If an activity has not completed its execution and it is canceled, its cancellation logic will be invoked if it is available.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e14bd-113">トランザクションと補正の詳細については、「 [トランザクション](workflow-transactions.md) と [補正](compensation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e14bd-113">For more information about transactions and compensation, see [Transactions](workflow-transactions.md) and [Compensation](compensation.md).</span></span>  
  
## <a name="using-cancellationscope"></a><span data-ttu-id="e14bd-114">CancellationScope の使用</span><span class="sxs-lookup"><span data-stu-id="e14bd-114">Using CancellationScope</span></span>  

 <span data-ttu-id="e14bd-115"><xref:System.Activities.Statements.CancellationScope> アクティビティには、子アクティビティを含めることができる <xref:System.Activities.Statements.CancellationScope.Body%2A> および <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> という 2 つのセクションがあります。</span><span class="sxs-lookup"><span data-stu-id="e14bd-115">The <xref:System.Activities.Statements.CancellationScope> activity has two sections that can contain child activities: <xref:System.Activities.Statements.CancellationScope.Body%2A> and <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span></span> <span data-ttu-id="e14bd-116"><xref:System.Activities.Statements.CancellationScope.Body%2A> には、アクティビティのロジックを構成するアクティビティを配置し、<xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> には、アクティビティの取り消しロジックを指定するアクティビティを配置します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-116">The <xref:System.Activities.Statements.CancellationScope.Body%2A> is where the activities that make up the logic of the activity are placed, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> is where the activities that provide cancellation logic for the activity are placed.</span></span> <span data-ttu-id="e14bd-117">アクティビティは、完了していない場合にのみ取り消すことができます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-117">An activity can be canceled only if it has not completed.</span></span> <span data-ttu-id="e14bd-118"><xref:System.Activities.Statements.CancellationScope> アクティビティの場合は、<xref:System.Activities.Statements.CancellationScope.Body%2A> のアクティビティが完了すると完了したことになります。</span><span class="sxs-lookup"><span data-stu-id="e14bd-118">In the case of the <xref:System.Activities.Statements.CancellationScope> activity, completion refers to the completion of the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span></span> <span data-ttu-id="e14bd-119">取り消し要求がスケジュールされている場合、<xref:System.Activities.Statements.CancellationScope.Body%2A> のアクティビティが完了していなければ、<xref:System.Activities.Statements.CancellationScope> が <xref:System.Activities.ActivityInstanceState.Canceled> とマークされ、<xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> アクティビティが実行されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-119">If a cancellation request is scheduled and the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A> have not completed, then the <xref:System.Activities.Statements.CancellationScope> will be marked as <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> activities will be executed.</span></span>  
  
### <a name="canceling-a-workflow-from-the-host"></a><span data-ttu-id="e14bd-120">ホストからのワークフローの取り消し</span><span class="sxs-lookup"><span data-stu-id="e14bd-120">Canceling a Workflow from the Host</span></span>  

 <span data-ttu-id="e14bd-121">ホストでワークフローを取り消すには、ワークフローをホストしている <xref:System.Activities.WorkflowApplication.Cancel%2A> インスタンスの <xref:System.Activities.WorkflowApplication> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-121">A host can cancel a workflow by calling the <xref:System.Activities.WorkflowApplication.Cancel%2A> method of the <xref:System.Activities.WorkflowApplication> instance that is hosting the workflow.</span></span> <span data-ttu-id="e14bd-122">次の例では、<xref:System.Activities.Statements.CancellationScope> を含むワークフローが作成されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-122">In the following example a workflow is created that has a <xref:System.Activities.Statements.CancellationScope>.</span></span> <span data-ttu-id="e14bd-123">このワークフローが呼び出され、ホストで <xref:System.Activities.WorkflowApplication.Cancel%2A> が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-123">The workflow is invoked, and then the host makes a call to <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="e14bd-124">ワークフローのメインの実行が停止し、<xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> の <xref:System.Activities.Statements.CancellationScope> メソッドが呼び出され、ワークフローがステータス <xref:System.Activities.ActivityInstanceState.Canceled> で完了します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-124">The main execution of the workflow is stopped, the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the <xref:System.Activities.Statements.CancellationScope> is invoked, and then the workflow completes with a status of <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#35](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#35)]  
  
 <span data-ttu-id="e14bd-125">このワークフローが呼び出されると、次の出力がコンソールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-125">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e14bd-126">**ワークフローを開始します。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-126">**Starting the workflow.**</span></span>  
<span data-ttu-id="e14bd-127">**CancellationHandler が呼び出されました。** 
**ワークフロー b30ebb30-df46-4d90-a211-e31c38d8db3c がが取り消されました。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-127">**CancellationHandler invoked.**
**Workflow b30ebb30-df46-4d90-a211-e31c38d8db3c Canceled.**</span></span>
> [!NOTE]
> <span data-ttu-id="e14bd-128"><xref:System.Activities.Statements.CancellationScope> アクティビティを取り消して <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> を呼び出す場合、適切な取り消しロジックを指定するには、ワークフローの作成者が、アクティビティが取り消されるまでの進行状況を確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e14bd-128">When a <xref:System.Activities.Statements.CancellationScope> activity is canceled and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> invoked, it is the responsibility of the workflow author to determine the progress that the canceled activity made before it was canceled in order to provide the appropriate cancellation logic.</span></span> <span data-ttu-id="e14bd-129"><xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> からは、取り消されるアクティビティの進行状況に関する情報は提供されません。</span><span class="sxs-lookup"><span data-stu-id="e14bd-129">The <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> does not provide any information about the progress of the canceled activity.</span></span>  
  
 <span data-ttu-id="e14bd-130">ワークフローのルートの後に未処理の例外がバブルアップされ、<xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> ハンドラーから <xref:System.Activities.UnhandledExceptionAction.Cancel> が返された場合も、ホストからワークフローを取り消すことができます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-130">A workflow can also be canceled from the host if an unhandled exception bubbles up past the root of the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler returns <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="e14bd-131">次の例では、ワークフローの開始後に、ワークフローから <xref:System.ApplicationException> がスローされます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-131">In this example the workflow starts and then throws an <xref:System.ApplicationException>.</span></span> <span data-ttu-id="e14bd-132">この例外はワークフローで処理されないため、<xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> ハンドラーが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-132">This exception is unhandled by the workflow and so the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="e14bd-133">ハンドラーがランタイムにワークフローを取り消すように指示し、現在実行中の <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> アクティビティの <xref:System.Activities.Statements.CancellationScope> が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-133">The handler instructs the runtime to cancel the workflow, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the currently executing <xref:System.Activities.Statements.CancellationScope> activity is invoked.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#36](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#36)]  
  
 <span data-ttu-id="e14bd-134">このワークフローが呼び出されると、次の出力がコンソールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-134">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e14bd-135">**ワークフローを開始します。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-135">**Starting the workflow.**</span></span>  
<span data-ttu-id="e14bd-136">**ワークフロー 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9** 
 の OnUnhandledException **ApplicationException がスローされました。** 
**CancellationHandler が呼び出されました。** 
**ワークフロー6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 が取り消されました。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-136">**OnUnhandledException in Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9**
**An ApplicationException was thrown.**
**CancellationHandler invoked.**
**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Canceled.**</span></span>

### <a name="canceling-an-activity-from-inside-a-workflow"></a><span data-ttu-id="e14bd-137">ワークフロー内部からのアクティビティの取り消し</span><span class="sxs-lookup"><span data-stu-id="e14bd-137">Canceling an Activity from Inside a Workflow</span></span>  

 <span data-ttu-id="e14bd-138">アクティビティは、親から取り消すこともできます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-138">An activity can also be canceled by its parent.</span></span> <span data-ttu-id="e14bd-139">たとえば、<xref:System.Activities.Statements.Parallel> アクティビティに実行中の分岐が複数ある場合、その <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> の評価結果が `true` になると、完了していない分岐は取り消されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-139">For example, if a <xref:System.Activities.Statements.Parallel> activity has multiple executing branches and its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true` then its incomplete branches will be canceled.</span></span> <span data-ttu-id="e14bd-140">次の例では、2 つの分岐がある <xref:System.Activities.Statements.Parallel> アクティビティが作成されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-140">In this example a <xref:System.Activities.Statements.Parallel> activity is created that has two branches.</span></span> <span data-ttu-id="e14bd-141"><xref:System.Activities.Statements.Parallel.CompletionCondition%2A> が `true` に設定されているため、どちらかの分岐が完了した時点で <xref:System.Activities.Statements.Parallel> が完了します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-141">Its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is set to `true` so the <xref:System.Activities.Statements.Parallel> completes as soon as any one of its branches is completed.</span></span> <span data-ttu-id="e14bd-142">この例では、分岐 2 が完了するため、分岐 1 が取り消されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-142">In this example branch 2 completes, and so branch 1 is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#37](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#37)]  
  
 <span data-ttu-id="e14bd-143">このワークフローが呼び出されると、次の出力がコンソールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-143">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e14bd-144">**ブランチ1を開始しています。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-144">**Branch 1 starting.**</span></span>  
<span data-ttu-id="e14bd-145">**分岐2が完了しました。** 
**分岐1が取り消されました。** 
**ワークフロー e0685e24-18ef-4a47-acf3-5c638732f3be がが完了しました。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-145">**Branch 2 complete.**
**Branch 1 canceled.**
**Workflow e0685e24-18ef-4a47-acf3-5c638732f3be Completed.**</span></span>  <span data-ttu-id="e14bd-146">アクティビティは、アクティビティのルートの後に例外がバブルアップされ、その例外がワークフローの上位で処理されていない場合にも取り消されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-146">Activities are also canceled if an exception bubbles up past the root of the activity but is handled at a higher level in the workflow.</span></span> <span data-ttu-id="e14bd-147">次の例では、ワークフローのメイン ロジックが <xref:System.Activities.Statements.Sequence> アクティビティで構成されています。</span><span class="sxs-lookup"><span data-stu-id="e14bd-147">In this example, the main logic of the workflow consists of a <xref:System.Activities.Statements.Sequence> activity.</span></span> <span data-ttu-id="e14bd-148"><xref:System.Activities.Statements.Sequence> は、<xref:System.Activities.Statements.CancellationScope.Body%2A> アクティビティに含まれる <xref:System.Activities.Statements.CancellationScope> アクティビティの <xref:System.Activities.Statements.TryCatch> として指定されています。</span><span class="sxs-lookup"><span data-stu-id="e14bd-148">The <xref:System.Activities.Statements.Sequence> is specified as the <xref:System.Activities.Statements.CancellationScope.Body%2A> of a <xref:System.Activities.Statements.CancellationScope> activity which is contained by a <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="e14bd-149"><xref:System.Activities.Statements.Sequence> の本体から例外がスローされて親の <xref:System.Activities.Statements.TryCatch> アクティビティによって処理され、<xref:System.Activities.Statements.Sequence> が取り消されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-149">An exception is thrown from the body of the <xref:System.Activities.Statements.Sequence>, is handled by the parent <xref:System.Activities.Statements.TryCatch> activity, and the <xref:System.Activities.Statements.Sequence> is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#39](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#39)]  
  
 <span data-ttu-id="e14bd-150">このワークフローが呼び出されると、次の出力がコンソールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-150">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e14bd-151">**シーケンスを開始します。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-151">**Sequence starting.**</span></span>  
<span data-ttu-id="e14bd-152">**シーケンスが取り消されました。** 
**例外がキャッチされました。** 
**ワークフロー e3c18939-121e-4c43-af1c-ba1ce977ce55 が完了しました。**</span><span class="sxs-lookup"><span data-stu-id="e14bd-152">**Sequence canceled.**
**Exception caught.**
**Workflow e3c18939-121e-4c43-af1c-ba1ce977ce55 Completed.**</span></span>

### <a name="throwing-exceptions-from-a-cancellationhandler"></a><span data-ttu-id="e14bd-153">CancellationHandler からの例外のスロー</span><span class="sxs-lookup"><span data-stu-id="e14bd-153">Throwing Exceptions from a CancellationHandler</span></span>  

 <span data-ttu-id="e14bd-154"><xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> の <xref:System.Activities.Statements.CancellationScope> からスローされるすべての例外は、ワークフローにとって致命的なものです。</span><span class="sxs-lookup"><span data-stu-id="e14bd-154">Any exceptions thrown from the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of a <xref:System.Activities.Statements.CancellationScope> are fatal to the workflow.</span></span> <span data-ttu-id="e14bd-155">例外が <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> からエスケープされる可能性がある場合は、<xref:System.Activities.Statements.TryCatch> の <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> を使用して、それらの例外をキャッチして処理するようにしてください。</span><span class="sxs-lookup"><span data-stu-id="e14bd-155">If there is a possibility of exceptions escaping from a <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, use a <xref:System.Activities.Statements.TryCatch> in the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> to catch and handle these exceptions.</span></span>  
  
### <a name="cancellation-using-compensableactivity"></a><span data-ttu-id="e14bd-156">CompensableActivity を使用した取り消し</span><span class="sxs-lookup"><span data-stu-id="e14bd-156">Cancellation using CompensableActivity</span></span>  

 <span data-ttu-id="e14bd-157"><xref:System.Activities.Statements.CancellationScope> アクティビティと同様に、<xref:System.Activities.Statements.CompensableActivity> には <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> があります。</span><span class="sxs-lookup"><span data-stu-id="e14bd-157">Like the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> has a <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span></span> <span data-ttu-id="e14bd-158"><xref:System.Activities.Statements.CompensableActivity> が取り消されると、その <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> に含まれるアクティビティが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-158">If a <xref:System.Activities.Statements.CompensableActivity> is canceled, any activities in its <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are invoked.</span></span> <span data-ttu-id="e14bd-159">これは、部分的に完了した補正可能な処理を元に戻す場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-159">This can be useful for undoing partially completed compensable work.</span></span> <span data-ttu-id="e14bd-160">を使用して補正とキャンセルを行う方法について <xref:System.Activities.Statements.CompensableActivity> は、「 [補正](compensation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e14bd-160">For information about how to use <xref:System.Activities.Statements.CompensableActivity> for compensation and cancellation, see [Compensation](compensation.md).</span></span>  
  
## <a name="cancellation-using-custom-activities"></a><span data-ttu-id="e14bd-161">カスタム アクティビティを使用した取り消し</span><span class="sxs-lookup"><span data-stu-id="e14bd-161">Cancellation using Custom Activities</span></span>  

 <span data-ttu-id="e14bd-162">カスタム アクティビティの作成者は、いくつかの方法でカスタム アクティビティに取り消しロジックを実装することができます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-162">Custom activity authors can implement cancellation logic into their custom activities in several different ways.</span></span> <span data-ttu-id="e14bd-163"><xref:System.Activities.Activity> から派生するカスタム アクティビティは、<xref:System.Activities.Statements.CancellationScope> またはキャンセル ロジックを含む他のカスタム アクティビティをアクティビティの本体に配置することによって、取り消しロジックを実装できます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-163">Custom activities that derive from <xref:System.Activities.Activity> can implement cancellation logic by placing a <xref:System.Activities.Statements.CancellationScope> or other custom activity that contains cancellation logic in the body of the activity.</span></span> <span data-ttu-id="e14bd-164"><xref:System.Activities.AsyncCodeActivity> および <xref:System.Activities.NativeActivity> から派生したアクティビティは、それぞれの <xref:System.Activities.NativeActivity.Cancel%2A> メソッドをオーバーライドして、取り消しロジックを提供できます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-164"><xref:System.Activities.AsyncCodeActivity> and <xref:System.Activities.NativeActivity> derived activities can override their respective <xref:System.Activities.NativeActivity.Cancel%2A> method and provide cancellation logic there.</span></span> <span data-ttu-id="e14bd-165"><xref:System.Activities.CodeActivity> 派生アクティビティでは取り消しの処置を行うことはできません。ランタイムが <xref:System.Activities.CodeActivity.Execute%2A> メソッドを呼び出すと、すべての作業が一度に実行されるためです。</span><span class="sxs-lookup"><span data-stu-id="e14bd-165"><xref:System.Activities.CodeActivity> derived activities do not provide any provision for cancellation because all their work is performed in a single burst of execution when the runtime calls the <xref:System.Activities.CodeActivity.Execute%2A> method.</span></span> <span data-ttu-id="e14bd-166">実行メソッドが呼び出される前に <xref:System.Activities.CodeActivity> ベースのアクティビティを取り消した場合、アクティビティはステータス <xref:System.Activities.ActivityInstanceState.Canceled> で終了し、<xref:System.Activities.CodeActivity.Execute%2A> メソッドは呼び出されません。</span><span class="sxs-lookup"><span data-stu-id="e14bd-166">If the execute method has not yet been called and a <xref:System.Activities.CodeActivity> based activity is canceled, the activity closes with a status of <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.CodeActivity.Execute%2A> method is not called.</span></span>  
  
### <a name="cancellation-using-nativeactivity"></a><span data-ttu-id="e14bd-167">NativeActivity を使用した取り消し</span><span class="sxs-lookup"><span data-stu-id="e14bd-167">Cancellation using NativeActivity</span></span>  

 <span data-ttu-id="e14bd-168"><xref:System.Activities.NativeActivity> 派生アクティビティでは、<xref:System.Activities.NativeActivity.Cancel%2A> メソッドをオーバーライドしてカスタムの取り消しロジックを指定できます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-168"><xref:System.Activities.NativeActivity> derived activities can override the <xref:System.Activities.NativeActivity.Cancel%2A> method to provide custom cancellation logic.</span></span> <span data-ttu-id="e14bd-169">このメソッドがオーバーライドされていない場合は、既定のワークフロー取り消しロジックが適用されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-169">If this method is not overridden, then the default workflow cancellation logic is applied.</span></span> <span data-ttu-id="e14bd-170">既定の取り消しは、メソッドをオーバーライドし <xref:System.Activities.NativeActivity> ない、 <xref:System.Activities.NativeActivity.Cancel%2A> または <xref:System.Activities.NativeActivity.Cancel%2A> メソッドが基本メソッドを呼び出す <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> に対して発生するプロセスです。</span><span class="sxs-lookup"><span data-stu-id="e14bd-170">Default cancellation is the process that occurs for a <xref:System.Activities.NativeActivity> that does not override the <xref:System.Activities.NativeActivity.Cancel%2A> method or whose <xref:System.Activities.NativeActivity.Cancel%2A> method calls the base <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="e14bd-171">アクティビティが取り消されると、ランタイムは、取り消し対象のフラグをアクティビティに設定し、特定のクリーンアップ処理を自動的に実行します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-171">When an activity is canceled, the runtime flags the activity for cancellation and automatically handles certain cleanup.</span></span> <span data-ttu-id="e14bd-172">アクティビティに未処理のブックマークしかない場合、それらのブックマークが削除され、アクティビティが <xref:System.Activities.ActivityInstanceState.Canceled> とマークされます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-172">If the activity only has outstanding bookmarks, the bookmarks will be removed and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="e14bd-173">取り消されるアクティビティに未処理の子アクティビティがある場合は、それらも取り消されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-173">Any outstanding child activities of the canceled activity will in turn be canceled.</span></span> <span data-ttu-id="e14bd-174">子アクティビティを追加でスケジュールしようとすると無視され、アクティビティは <xref:System.Activities.ActivityInstanceState.Canceled> とマークされます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-174">Any attempt to schedule additional child activities will result in the attempt being ignored and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="e14bd-175">未処理の子アクティビティが <xref:System.Activities.ActivityInstanceState.Canceled> または <xref:System.Activities.ActivityInstanceState.Faulted> の状態で完了した場合、アクティビティは <xref:System.Activities.ActivityInstanceState.Canceled> とマークされます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-175">If any outstanding child activity completes in the <xref:System.Activities.ActivityInstanceState.Canceled> or <xref:System.Activities.ActivityInstanceState.Faulted> state, then the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="e14bd-176">取り消し要求は無視される場合があることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="e14bd-176">Note that a cancellation request can be ignored.</span></span> <span data-ttu-id="e14bd-177">アクティビティに未処理のブックマークも実行中の子アクティビティもなく、取り消し対象のフラグが設定された後に追加の作業項目のスケジュールも行っていない場合は、アクティビティが正常に完了します。</span><span class="sxs-lookup"><span data-stu-id="e14bd-177">If an activity does not have any outstanding bookmarks or executing child activities and does not schedule any additional work items after being flagged for cancellation, it will complete successfully.</span></span> <span data-ttu-id="e14bd-178">ほとんどの場合はこの既定の取り消しで十分ですが、別の取り消しロジックが必要な場合は、組み込みの取り消しアクティビティやカスタム アクティビティを使用できます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-178">This default cancellation suffices for many scenarios, but if additional cancellation logic is needed, then the built-in cancellation activities or custom activities can be used.</span></span>  
  
 <span data-ttu-id="e14bd-179">次の例では、<xref:System.Activities.NativeActivity.Cancel%2A> ベースのカスタム <xref:System.Activities.NativeActivity> アクティビティの `ParallelForEach` オーバーライドが定義されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-179">In the following example, the <xref:System.Activities.NativeActivity.Cancel%2A> override of a <xref:System.Activities.NativeActivity> based custom `ParallelForEach` activity is defined.</span></span> <span data-ttu-id="e14bd-180">アクティビティが取り消されると、このオーバーライドによってアクティビティの取り消しロジックが処理されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-180">When the activity is canceled, this override handles the cancellation logic for the activity.</span></span> <span data-ttu-id="e14bd-181">この例は、 [非ジェネリック ParallelForEach](./samples/non-generic-parallelforeach.md) サンプルに含まれています。</span><span class="sxs-lookup"><span data-stu-id="e14bd-181">This example is part of the [Non-Generic ParallelForEach](./samples/non-generic-parallelforeach.md) sample.</span></span>  
  
```csharp  
protected override void Cancel(NativeActivityContext context)  
{  
    // If we do not have a completion condition then we can just  
    // use default logic.  
    if (this.CompletionCondition == null)  
    {  
        base.Cancel(context);  
    }  
    else  
    {  
        context.CancelChildren();  
    }  
}  
```  
  
 <span data-ttu-id="e14bd-182"><xref:System.Activities.NativeActivity> 派生アクティビティでは、<xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> プロパティを調べることによって取り消しが要求されたかどうかを確認し、<xref:System.Activities.NativeActivityContext.MarkCanceled%2A> メソッドを呼び出して取り消し対象としてマークできます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-182"><xref:System.Activities.NativeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> method.</span></span> <span data-ttu-id="e14bd-183"><xref:System.Activities.NativeActivityContext.MarkCanceled%2A> を呼び出した後、すぐにアクティビティが完了するわけではありません。</span><span class="sxs-lookup"><span data-stu-id="e14bd-183">Calling <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> does not immediately complete the activity.</span></span> <span data-ttu-id="e14bd-184">ランタイムは通常どおり、未処理の処理がなくなってからアクティビティを完了します。ただし、<xref:System.Activities.NativeActivityContext.MarkCanceled%2A> が呼び出された場合は、最終的な状態が <xref:System.Activities.ActivityInstanceState.Canceled> ではなく <xref:System.Activities.ActivityInstanceState.Closed> になります。</span><span class="sxs-lookup"><span data-stu-id="e14bd-184">As usual, the runtime will complete the activity when it has no more outstanding work, but if <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> is called the final state will be <xref:System.Activities.ActivityInstanceState.Canceled> instead of <xref:System.Activities.ActivityInstanceState.Closed>.</span></span>  
  
### <a name="cancellation-using-asynccodeactivity"></a><span data-ttu-id="e14bd-185">AsyncCodeActivity を使用した取り消し</span><span class="sxs-lookup"><span data-stu-id="e14bd-185">Cancellation using AsyncCodeActivity</span></span>  

 <span data-ttu-id="e14bd-186"><xref:System.Activities.AsyncCodeActivity> ベースのアクティビティでも、<xref:System.Activities.AsyncCodeActivity.Cancel%2A> メソッドをオーバーライドしてカスタムの取り消しロジックを指定できます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-186"><xref:System.Activities.AsyncCodeActivity> based activities can also provide custom cancellation logic by overriding the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="e14bd-187">このメソッドがオーバーライドされていない場合は、アクティビティが取り消されても取り消し処理は実行されません。</span><span class="sxs-lookup"><span data-stu-id="e14bd-187">If this method is not overridden, then no cancellation handling is performed if the activity is canceled.</span></span> <span data-ttu-id="e14bd-188">次の例では、<xref:System.Activities.AsyncCodeActivity.Cancel%2A> ベースのカスタム <xref:System.Activities.AsyncCodeActivity> アクティビティの `ExecutePowerShell` オーバーライドが定義されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-188">In the following example, the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override of an <xref:System.Activities.AsyncCodeActivity> based custom `ExecutePowerShell` activity is defined.</span></span> <span data-ttu-id="e14bd-189">アクティビティが取り消されると、必要な取り消し動作が実行されます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-189">When the activity is canceled, it performs the desired cancellation behavior.</span></span>
  
 [!code-csharp[CFX_WorkflowApplicationExample#1020](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1020)]  
  
 <span data-ttu-id="e14bd-190"><xref:System.Activities.AsyncCodeActivity> 派生アクティビティでは、<xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> プロパティを調べることによって取り消しが要求されたかどうかを確認し、<xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> メソッドを呼び出して取り消し対象としてマークできます。</span><span class="sxs-lookup"><span data-stu-id="e14bd-190"><xref:System.Activities.AsyncCodeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> method.</span></span>
