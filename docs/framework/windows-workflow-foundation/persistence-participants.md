---
description: '詳細情報: 永続参加要素'
title: 永続参加要素
ms.date: 03/30/2017
ms.assetid: f84d2d5d-1c1b-4f19-be45-65b552d3e9e3
ms.openlocfilehash: 66f39bfe5b9efcae5d8377fda9415efd4cab9468
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99742057"
---
# <a name="persistence-participants"></a><span data-ttu-id="398f1-103">永続参加要素</span><span class="sxs-lookup"><span data-stu-id="398f1-103">Persistence Participants</span></span>

<span data-ttu-id="398f1-104">永続参加要素は、アプリケーション ホストによってトリガーされる永続化操作 (保存または読み込み) に参加できます。</span><span class="sxs-lookup"><span data-stu-id="398f1-104">A persistence participant can participate in a persistence operation (Save or Load) triggered by an application host.</span></span> <span data-ttu-id="398f1-105">には、 [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] **PersistenceParticipant** と **PersistenceIOParticipant** という2つの抽象クラスが付属しています。このクラスを使用して、永続参加要素を作成できます。</span><span class="sxs-lookup"><span data-stu-id="398f1-105">The [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] ships with two abstract classes, **PersistenceParticipant** and **PersistenceIOParticipant**, which you can use to create a persistence participant.</span></span> <span data-ttu-id="398f1-106">永続参加要素はこれらのクラスの 1 つから派生し、目的のメソッドを実装して、このクラスのインスタンスを <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> の <xref:System.ServiceModel.Activities.WorkflowServiceHost> コレクションに追加します。</span><span class="sxs-lookup"><span data-stu-id="398f1-106">A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> collection on the <xref:System.ServiceModel.Activities.WorkflowServiceHost> .</span></span> <span data-ttu-id="398f1-107">アプリケーション ホストは、ワークフロー インスタンスを永続化するときにこのようなワークフロー拡張機能を必要とする場合があり、適切なときに永続参加要素の適切なメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="398f1-107">The application host may look for such workflow extensions when persisting a workflow instance and invoke appropriate methods on the persistence participants at appropriate times.</span></span>  
  
 <span data-ttu-id="398f1-108">次の一覧では、永続化 (保存) 操作のさまざまな段階で永続化サブシステムが実行するタスクについて説明します。</span><span class="sxs-lookup"><span data-stu-id="398f1-108">The following list describes the tasks performed by the persistence subsystem in different stages of the Persist (Save) operation.</span></span> <span data-ttu-id="398f1-109">3 番目および 4 番目の段階で永続参加要素が使用されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-109">The persistence participants are used in the third and fourth stages.</span></span> <span data-ttu-id="398f1-110">参加要素が i/o 参加要素 (i/o 操作にも参加する永続参加要素) である場合、参加者は6番目のステージでも使用されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-110">If the participant is an I/O participant (a persistence participant that also participates in I/O operations), the participant is also used in the sixth stage.</span></span>  
  
1. <span data-ttu-id="398f1-111">ワークフロー状態、ブックマーク、マップされた変数、およびタイムスタンプなどの組み込みの値を収集します。</span><span class="sxs-lookup"><span data-stu-id="398f1-111">Gathers built-in values, including workflow state, bookmarks, mapped variables, and timestamp.</span></span>  
  
2. <span data-ttu-id="398f1-112">ワークフロー インスタンスに関連付けられた拡張コレクションに追加された永続参加要素を収集します。</span><span class="sxs-lookup"><span data-stu-id="398f1-112">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
3. <span data-ttu-id="398f1-113">すべての永続参加要素によって実装された <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="398f1-113">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method implemented by all persistence participants.</span></span>  
  
4. <span data-ttu-id="398f1-114">すべての永続参加要素によって実装された <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="398f1-114">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method implemented by all persistence participants.</span></span>  
  
5. <span data-ttu-id="398f1-115">ワークフローを永続ストアに永続化または保存します。</span><span class="sxs-lookup"><span data-stu-id="398f1-115">Persist or save the workflow into the persistence store.</span></span>  
  
6. <span data-ttu-id="398f1-116">すべての <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> 永続 i/o 参加要素に対してメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="398f1-116">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> method on all of the persistence I/O participants.</span></span> <span data-ttu-id="398f1-117">参加者が i/o 参加要素ではない場合、このタスクはスキップされます。</span><span class="sxs-lookup"><span data-stu-id="398f1-117">If the participant is not an I/O participant, this task is skipped.</span></span> <span data-ttu-id="398f1-118">永続化がトランザクションである場合、Transaction.Current プロパティにトランザクションが提供されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-118">If the persistence episode is transactional, the transaction is provided in Transaction.Current property.</span></span>  
  
7. <span data-ttu-id="398f1-119">すべての永続参加要素が完了するのを待機します。</span><span class="sxs-lookup"><span data-stu-id="398f1-119">Waits for all persistence participants to complete.</span></span> <span data-ttu-id="398f1-120">すべての参加要素がインスタンス データの永続化に成功したら、トランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="398f1-120">If all the participants succeed in persisting instance data, commits the transaction.</span></span>  
  
 <span data-ttu-id="398f1-121">永続参加要素は **PersistenceParticipant** クラスから派生し、 **Collectvalues** および **mapvalues** メソッドを実装できます。</span><span class="sxs-lookup"><span data-stu-id="398f1-121">A persistence participant derives from the **PersistenceParticipant** class and may implement the **CollectValues** and **MapValues** methods.</span></span> <span data-ttu-id="398f1-122">永続 i/o 参加要素は **PersistenceIOParticipant** クラスから派生し、 **Collectvalues** および **mapvalues** メソッドの実装に加えて **beginonsave** メソッドを実装できます。</span><span class="sxs-lookup"><span data-stu-id="398f1-122">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnSave** method in addition to implementing the **CollectValues** and **MapValues** methods.</span></span>  
  
 <span data-ttu-id="398f1-123">それぞれの段階の完了後に次の段階が開始されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-123">Each stage is completed before the next stage begins.</span></span> <span data-ttu-id="398f1-124">たとえば、最初の段階で **すべて** の永続参加要素から値が収集されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-124">For example, values are collected from **all** persistence participants in the first stage.</span></span> <span data-ttu-id="398f1-125">2 番目の段階では、最初の段階で収集されたすべての値がマップのためにすべての永続参加要素に提供されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-125">Then all the values collected in the first stage are provided to all persistence participants in the second stage for mapping.</span></span> <span data-ttu-id="398f1-126">3 番目の段階では、1 番目および 2 番目の段階で収集してマップされたすべての値が永続参加要素に提供されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-126">Then all the values collected and mapped in the first and second stages are provided to the persistence provider in the third stage, and so on.</span></span>  
  
 <span data-ttu-id="398f1-127">次の一覧では、読み込み操作のさまざまな段階で永続化サブシステムが実行するタスクについて説明します。</span><span class="sxs-lookup"><span data-stu-id="398f1-127">The following list describes the tasks performed by the persistence subsystem in different stages of the Load operation.</span></span> <span data-ttu-id="398f1-128">4 番目の段階で永続参加要素が使用されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-128">The persistence participants are used in the fourth stage.</span></span> <span data-ttu-id="398f1-129">永続 i/o 参加要素 (i/o 操作にも参加する永続参加要素) は、3番目の段階でも使用されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-129">The persistence I/O participants (persistence participants that also participate in I/O operations) are also used in the third stage.</span></span>  
  
1. <span data-ttu-id="398f1-130">ワークフロー インスタンスに関連付けられた拡張コレクションに追加された永続参加要素を収集します。</span><span class="sxs-lookup"><span data-stu-id="398f1-130">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
2. <span data-ttu-id="398f1-131">永続ストアからワークフローを読み込みます。</span><span class="sxs-lookup"><span data-stu-id="398f1-131">Loads the workflow from the persistence store.</span></span>  
  
3. <span data-ttu-id="398f1-132">すべての <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> 永続 i/o 参加要素でを呼び出し、すべての永続参加要素が完了するまで待機します。</span><span class="sxs-lookup"><span data-stu-id="398f1-132">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> on all persistence I/O participants and waits for all the persistence participants to complete.</span></span> <span data-ttu-id="398f1-133">永続化がトランザクションである場合、Transaction.Current にトランザクションが提供されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-133">If the persistence episode is transactional, the transaction is provided in Transaction.Current.</span></span>  
  
4. <span data-ttu-id="398f1-134">永続ストアから取得されたデータに基づいて、メモリ内のワークフロー インスタンスを読み込みます。</span><span class="sxs-lookup"><span data-stu-id="398f1-134">Loads the workflow instance in memory based on the data retrieved from the persistence store.</span></span>  
  
5. <span data-ttu-id="398f1-135">各永続参加要素の <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="398f1-135">Invokes <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> on each persistence participant.</span></span>  
  
 <span data-ttu-id="398f1-136">永続参加要素は **PersistenceParticipant** クラスから派生し、 **publishvalues** メソッドを実装できます。</span><span class="sxs-lookup"><span data-stu-id="398f1-136">A persistence participant derives from the **PersistenceParticipant** class and may implement the **PublishValues** method.</span></span> <span data-ttu-id="398f1-137">永続 i/o 参加要素は **PersistenceIOParticipant** クラスから派生し、 **publishvalues** メソッドの実装に加えて **beginonload** メソッドを実装できます。</span><span class="sxs-lookup"><span data-stu-id="398f1-137">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnLoad** method in addition to implementing the **PublishValues** method.</span></span>  
  
 <span data-ttu-id="398f1-138">ワークフロー インスタンスを読み込む場合、永続化プロバイダーはそのインスタンスのロックを作成します。</span><span class="sxs-lookup"><span data-stu-id="398f1-138">When loading a workflow instance the persistence provider creates a lock on that instance.</span></span> <span data-ttu-id="398f1-139">これにより、各インスタンスが複数ノードのシナリオでは、複数のホストによって読み込まれることはありません。</span><span class="sxs-lookup"><span data-stu-id="398f1-139">This prevents the instance from being loaded by more than one host in a multi-node scenario.</span></span> <span data-ttu-id="398f1-140">ロックされたワークフロー インスタンスを読み込もうとすると、次のような例外が表示されます: 例外「System.ServiceModel.Persistence.InstanceLockException: 要求された操作は、インスタンス '00000000-0000-0000-0000-000000000000' のロックが取得できなかったため、完了できませんでした」。</span><span class="sxs-lookup"><span data-stu-id="398f1-140">If you attempt to load a workflow instance that has been locked you will see an exception like the following: The exception " System.ServiceModel.Persistence.InstanceLockException: The requested operation could not complete because the lock for instance '00000000-0000-0000-0000-000000000000' could not be acquired".</span></span> <span data-ttu-id="398f1-141">このエラーが発生するのは、次のいずれかが発生した場合です。</span><span class="sxs-lookup"><span data-stu-id="398f1-141">This error is caused when one of the following occurs:</span></span>  
  
- <span data-ttu-id="398f1-142">複数ノード シナリオで、インスタンスが他のホストによって読み込まれます。</span><span class="sxs-lookup"><span data-stu-id="398f1-142">In a multi-node scenario the instance is loaded by another host.</span></span>  <span data-ttu-id="398f1-143">これらの種類の競合を解決する方法がいくつかあります。ロックと再試行を所有するノードへ処理を転送するか、または他のホストでの作業を保存できないようにする読み込みを強制します。</span><span class="sxs-lookup"><span data-stu-id="398f1-143">There are a few different ways to resolve these types of conflicts: forward the processing to the node which owns the lock and retry, or force the load which will cause the other host to be unable to save their work.</span></span>  
  
- <span data-ttu-id="398f1-144">単一ノード シナリオで、ホストがクラッシュしました。</span><span class="sxs-lookup"><span data-stu-id="398f1-144">In a single-node scenario and the host crashed.</span></span>  <span data-ttu-id="398f1-145">ホストが再度起動されるとき (プロセスのリサイクル、または新しい永続化プロバイダー ファクトリの作成)、新しいホストが、ロックの期限がまだ切れていないために古いホストによってまだロックされているインスタンスの読み込みを試みます。</span><span class="sxs-lookup"><span data-stu-id="398f1-145">When the host starts up again (a process recycle or creating a new persistence provider factory) the new host attempts to load an instance which is still locked by the old host because the lock hasn't expired yet.</span></span>  
  
- <span data-ttu-id="398f1-146">単一ノード シナリオで、当該インスタンスがあるポイントで中止され、別のホスト ID を持つ新しい永続化プロバイダー インスタンスが作成されます。</span><span class="sxs-lookup"><span data-stu-id="398f1-146">In a single-node scenario and the instance in question was aborted at some point and a new persistence provider instance is created which has a different host ID.</span></span>  
  
 <span data-ttu-id="398f1-147">ロックのタイムアウト値の既定値は 5 分です。呼び出したときに、別のタイムアウト値を指定できます <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>。</span><span class="sxs-lookup"><span data-stu-id="398f1-147">The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="398f1-148">このセクションの内容</span><span class="sxs-lookup"><span data-stu-id="398f1-148">In This Section</span></span>  
  
- [<span data-ttu-id="398f1-149">方法: カスタム永続参加要素を作成する</span><span class="sxs-lookup"><span data-stu-id="398f1-149">How to: Create a Custom Persistence Participant</span></span>](how-to-create-a-custom-persistence-participant.md)  
  
## <a name="see-also"></a><span data-ttu-id="398f1-150">関連項目</span><span class="sxs-lookup"><span data-stu-id="398f1-150">See also</span></span>

- [<span data-ttu-id="398f1-151">ストア拡張</span><span class="sxs-lookup"><span data-stu-id="398f1-151">Store Extensibility</span></span>](store-extensibility.md)
