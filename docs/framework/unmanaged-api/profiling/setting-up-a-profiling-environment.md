---
description: 詳細については、「プロファイル環境の設定」を参照してください。
title: プロファイル環境の設定
ms.date: 03/30/2017
helpviewer_keywords:
- environment variables, profiling API
- profiling API [.NET Framework], setting up environment
- COR_PROFILER environment variable
- Windows Service applications, profiling
- profiling API [.NET Framework], Windows Service applications
- COR_ENABLE_PROFILING environment variable
- profiling API [.NET Framework], enabling
ms.assetid: fefca07f-7555-4e77-be86-3c542e928312
ms.openlocfilehash: 88bfb50b02874bf79f03414213329c5dcc79a9fa
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99646349"
---
# <a name="setting-up-a-profiling-environment"></a><span data-ttu-id="06e19-103">プロファイル環境の設定</span><span class="sxs-lookup"><span data-stu-id="06e19-103">Setting Up a Profiling Environment</span></span>

> [!NOTE]
> <span data-ttu-id="06e19-104">.NET Framework 4 では、プロファイリングに大幅な変更が加えられています。</span><span class="sxs-lookup"><span data-stu-id="06e19-104">There have been substantial changes to profiling in the .NET Framework 4.</span></span>  
  
 <span data-ttu-id="06e19-105">マネージド プロセス (アプリケーションまたはサービス) は、起動されると、共通言語ランタイム (CLR: Common Language Runtime) を読み込みます。</span><span class="sxs-lookup"><span data-stu-id="06e19-105">When a managed process (application or service) starts, it loads the common language runtime (CLR).</span></span> <span data-ttu-id="06e19-106">CLR は、初期化されると、プロファイラーに接続する必要があるかどうかを決定するために、次の 2 つの環境変数を評価します。</span><span class="sxs-lookup"><span data-stu-id="06e19-106">When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:</span></span>  
  
- <span data-ttu-id="06e19-107">COR_ENABLE_PROFILING: この環境変数が存在し、1 に設定されている場合にのみ、CLR はプロファイラーに接続します。</span><span class="sxs-lookup"><span data-stu-id="06e19-107">COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.</span></span>  
  
- <span data-ttu-id="06e19-108">COR_PROFILER: COR_ENABLE_PROFILING のチェックに合格した場合、CLR はこの CLSID または ProgID (あらかじめレジストリに格納されている) を持つプロファイラーに接続します。</span><span class="sxs-lookup"><span data-stu-id="06e19-108">COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.</span></span> <span data-ttu-id="06e19-109">COR_PROFILER 環境変数は文字列として定義されます。以下に 2 つの例を示します。</span><span class="sxs-lookup"><span data-stu-id="06e19-109">The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.</span></span>  
  
    ```cpp  
    set COR_PROFILER={32E2F4DA-1BEA-47ea-88F9-C5DAF691C94A}  
    set COR_PROFILER="MyProfiler"  
    ```  
  
 <span data-ttu-id="06e19-110">CLR アプリケーションのプロファイリングを行うには、COR_ENABLE_PROFILING 環境変数および COR_PROFILER 環境変数を設定してから、アプリケーションを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-110">To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application.</span></span> <span data-ttu-id="06e19-111">また、プロファイラー DLL が登録済みであることも確認してください。</span><span class="sxs-lookup"><span data-stu-id="06e19-111">You must also make sure that the profiler DLL is registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="06e19-112">.NET Framework 4 以降では、プロファイラーを登録する必要がありません。</span><span class="sxs-lookup"><span data-stu-id="06e19-112">Starting with the .NET Framework 4, profilers do not have to be registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="06e19-113">.NET Framework 4 以降のバージョンで .NET Framework バージョン2.0、3.0、および3.5 プロファイラーを使用するには、COMPLUS_ProfAPI_ProfilerCompatibilitySetting 環境変数を設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-113">To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the .NET Framework 4 and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.</span></span>  
  
## <a name="environment-variable-scope"></a><span data-ttu-id="06e19-114">環境変数名のスコープ</span><span class="sxs-lookup"><span data-stu-id="06e19-114">Environment Variable Scope</span></span>  

 <span data-ttu-id="06e19-115">COR_ENABLE_PROFILING 環境変数と COR_PROFILER 環境変数をどのように設定するかによって、これらの変数が影響を及ぼすスコープが決定します。</span><span class="sxs-lookup"><span data-stu-id="06e19-115">How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence.</span></span> <span data-ttu-id="06e19-116">これらの変数は、次のいずれかの方法で設定できます。</span><span class="sxs-lookup"><span data-stu-id="06e19-116">You can set these variables in one of the following ways:</span></span>  
  
- <span data-ttu-id="06e19-117">[ICorDebug:: CreateProcess](../debugging/icordebug-createprocess-method.md)呼び出しで変数を設定した場合、その変数は、その時点で実行しているアプリケーションにのみ適用されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-117">If you set the variables in an [ICorDebug::CreateProcess](../debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time.</span></span> <span data-ttu-id="06e19-118">(そのアプリケーションから起動されて環境を継承する他のアプリケーションにも適用されます)。</span><span class="sxs-lookup"><span data-stu-id="06e19-118">(They will also apply to other applications started by that application that inherit the environment.)</span></span>  
  
- <span data-ttu-id="06e19-119">コマンド プロンプト ウィンドウで設定した変数は、そのウィンドウから起動したすべてのアプリケーションに適用されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-119">If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.</span></span>  
  
- <span data-ttu-id="06e19-120">ユーザー レベルで設定した変数は、エクスプローラーを使用して開始するすべてのアプリケーションに適用されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-120">If you set the variables at the user level, they will apply to all applications that you start with File Explorer.</span></span> <span data-ttu-id="06e19-121">変数を設定した後にコマンド プロンプト ウィンドウを開くと、それらの環境設定が表示されます。そのウィンドウから起動するアプリケーションにも同じ設定が適用されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-121">A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="06e19-122">ユーザーレベルで環境変数を設定するには、[ **マイコンピューター** を右クリックし、[ **プロパティ**] をクリックします。 [ **詳細設定** ] タブをクリックし、[ **環境変数**] をクリックして、変数を [ **ユーザー変数** ] の一覧に追加します。</span><span class="sxs-lookup"><span data-stu-id="06e19-122">To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list.</span></span>  
  
- <span data-ttu-id="06e19-123">コンピューター レベルで設定した変数は、そのコンピューターで起動するすべてのアプリケーションに適用されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-123">If you set the variables at the computer level, they will apply to all applications that are started on that computer.</span></span> <span data-ttu-id="06e19-124">そのコンピューターでコマンド プロンプト ウィンドウを開くと、それらの環境設定が表示されます。そのウィンドウから起動するアプリケーションにも同じ設定が適用されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-124">A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="06e19-125">つまり、そのコンピューター上のすべてのマネージド プロセスがプロファイラーと共に起動します。</span><span class="sxs-lookup"><span data-stu-id="06e19-125">This means that every managed process on that computer will start with your profiler.</span></span> <span data-ttu-id="06e19-126">コンピューターレベルで環境変数を設定するには、 **マイコンピューター** を右クリックし、[ **プロパティ**] をクリックします。次に、[ **詳細設定** ] タブをクリックし、[ **環境変数**] をクリックします。次に、変数を [ **システム変数** ] の一覧に追加してから、コンピューターを再起動します。</span><span class="sxs-lookup"><span data-stu-id="06e19-126">To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer.</span></span> <span data-ttu-id="06e19-127">再起動後、変数はシステム全体で試用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="06e19-127">After restarting, the variables will be available system-wide.</span></span>  
  
 <span data-ttu-id="06e19-128">Windows サービスのプロファイリングを行う場合は、環境変数を設定した後、コンピューターを再起動してプロファイラー DLL を登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-128">If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL.</span></span> <span data-ttu-id="06e19-129">これらの考慮事項の詳細については、「 [Windows サービスのプロファイリング](#windows_service)」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="06e19-129">For more information about these considerations, see the section [Profiling a Windows Service](#windows_service).</span></span>  
  
## <a name="additional-considerations"></a><span data-ttu-id="06e19-130">その他の考慮事項</span><span class="sxs-lookup"><span data-stu-id="06e19-130">Additional Considerations</span></span>  
  
- <span data-ttu-id="06e19-131">プロファイラークラスは、 [ICorProfilerCallback](icorprofilercallback-interface.md) インターフェイスと [ICorProfilerCallback2](icorprofilercallback2-interface.md) インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="06e19-131">The profiler class implements the [ICorProfilerCallback](icorprofilercallback-interface.md) and [ICorProfilerCallback2](icorprofilercallback2-interface.md) interfaces.</span></span> <span data-ttu-id="06e19-132">.NET Framework Version 2.0 では、プロファイラーは `ICorProfilerCallback2` を実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-132">In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`.</span></span> <span data-ttu-id="06e19-133">実装していない場合、`ICorProfilerCallback2` は読み込まれません。</span><span class="sxs-lookup"><span data-stu-id="06e19-133">If it does not, `ICorProfilerCallback2` will not be loaded.</span></span>  
  
- <span data-ttu-id="06e19-134">一度に 1 つのプロファイラーのみが、指定された環境でプロセスのプロファイリングを行うことができます。</span><span class="sxs-lookup"><span data-stu-id="06e19-134">Only one profiler can profile a process at one time in a given environment.</span></span> <span data-ttu-id="06e19-135">2 つの異なるプロファイラーを別々の環境に登録することはできますが、各プロファイラーは別々のプロセスのプロファイリングを行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-135">You can register two different profilers in different environments, but each must profile separate processes.</span></span> <span data-ttu-id="06e19-136">プロファイラーは、インプロセス COM サーバー DLL として実装する必要があります。この DLL は、プロファイリング対象プロセスと同じアドレス領域にマップされます。</span><span class="sxs-lookup"><span data-stu-id="06e19-136">The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled.</span></span> <span data-ttu-id="06e19-137">つまり、プロファイラーはインプロセスで実行されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-137">This means that the profiler runs in-process.</span></span> <span data-ttu-id="06e19-138">.NET Framework では、これ以外の種類の COM サーバーはサポートしていません。</span><span class="sxs-lookup"><span data-stu-id="06e19-138">The .NET Framework does not support any other type of COM server.</span></span> <span data-ttu-id="06e19-139">たとえば、プロファイラーがリモート コンピューターからアプリケーションを監視する場合は、各コンピューターにコレクター エージェントを実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-139">For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer.</span></span> <span data-ttu-id="06e19-140">実装したエージェントは、結果をまとめて中央のデータ収集用コンピューターに送信します。</span><span class="sxs-lookup"><span data-stu-id="06e19-140">These agents will batch results and communicate them to the central data collection computer.</span></span>  
  
- <span data-ttu-id="06e19-141">プロファイラーはインプロセスでインスタンス化される COM オブジェクトであるため、プロファイリングされる各アプリケーションに専用のプロファイラーのコピーが存在します。</span><span class="sxs-lookup"><span data-stu-id="06e19-141">Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler.</span></span> <span data-ttu-id="06e19-142">したがって、単一のプロファイラー インスタンスが複数のアプリケーションからのデータを処理する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="06e19-142">Therefore, a single profiler instance does not have to handle data from multiple applications.</span></span> <span data-ttu-id="06e19-143">ただし、プロファイラーのログ コードに、他のプロファイリング対象アプリケーションからのログ ファイルの上書きを回避するロジックを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-143">However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.</span></span>  
  
## <a name="initializing-the-profiler"></a><span data-ttu-id="06e19-144">プロファイラーの初期化</span><span class="sxs-lookup"><span data-stu-id="06e19-144">Initializing the Profiler</span></span>  

 <span data-ttu-id="06e19-145">両方の環境変数のチェックに合格すると、CLR は COM `CoCreateInstance` 関数と同様の方法でプロファイルのインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="06e19-145">When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function.</span></span> <span data-ttu-id="06e19-146">このプロファイルについては、`CoCreateInstance` の直接呼び出しによる読み込みは行われません。</span><span class="sxs-lookup"><span data-stu-id="06e19-146">The profiler is not loaded through a direct call to `CoCreateInstance`.</span></span> <span data-ttu-id="06e19-147">そのため、スレッド処理モデルの設定が必要な `CoInitialize` の呼び出しが回避されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-147">Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided.</span></span> <span data-ttu-id="06e19-148">CLR は、プロファイラーで [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="06e19-148">The CLR then calls the [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) method in the profiler.</span></span> <span data-ttu-id="06e19-149">このメソッドのシグネチャは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="06e19-149">The signature of this method is as follows.</span></span>  
  
```cpp  
HRESULT Initialize(IUnknown *pICorProfilerInfoUnk)  
```  
  
 <span data-ttu-id="06e19-150">プロファイラーは、 `pICorProfilerInfoUnk` プロファイル中により多くの情報を要求できるように、 [ICorProfilerInfo](icorprofilerinfo-interface.md) または [ICorProfilerInfo2](icorprofilerinfo2-interface.md) インターフェイスポインターを照会して保存する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-150">The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](icorprofilerinfo-interface.md) or [ICorProfilerInfo2](icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling.</span></span>  
  
## <a name="setting-event-notifications"></a><span data-ttu-id="06e19-151">イベント通知の設定</span><span class="sxs-lookup"><span data-stu-id="06e19-151">Setting Event Notifications</span></span>  

 <span data-ttu-id="06e19-152">次に、プロファイラーは [ICorProfilerInfo:: SetEventMask](icorprofilerinfo-seteventmask-method.md) メソッドを呼び出して、関心のある通知のカテゴリを指定します。</span><span class="sxs-lookup"><span data-stu-id="06e19-152">The profiler then calls the [ICorProfilerInfo::SetEventMask](icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in.</span></span> <span data-ttu-id="06e19-153">たとえば、関数の Enter および Leave の通知とガベージ コレクションの通知のみを確認する場合は、次のように指定します。</span><span class="sxs-lookup"><span data-stu-id="06e19-153">For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.</span></span>  
  
```cpp  
ICorProfilerInfo* pInfo;  
pICorProfilerInfoUnk->QueryInterface(IID_ICorProfilerInfo, (void**)&pInfo);  
pInfo->SetEventMask(COR_PRF_MONITOR_ENTERLEAVE | COR_PRF_MONITOR_GC)  
```  
  
 <span data-ttu-id="06e19-154">通知マスクをこのように設定することによって、プロファイラーで受け取る通知を制限できます。</span><span class="sxs-lookup"><span data-stu-id="06e19-154">By setting the notifications mask in this manner, the profiler can limit which notifications it receives.</span></span> <span data-ttu-id="06e19-155">この方法は、単純なプロファイラーまたは特別な目的を持つプロファイラーを作成するときに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="06e19-155">This approach helps the user build a simple or special-purpose profiler.</span></span> <span data-ttu-id="06e19-156">また、プロファイラーが無視するだけの通知を送信するのに消費される CPU 時間が削減されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-156">It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.</span></span>  
  
 <span data-ttu-id="06e19-157">特定のプロファイラー イベントは変更できません。</span><span class="sxs-lookup"><span data-stu-id="06e19-157">Certain profiler events are immutable.</span></span> <span data-ttu-id="06e19-158">つまり、これらのイベントが `ICorProfilerCallback::Initialize` コールバックで設定されるとすぐに、イベントはオフにできなくなり、新しいイベントをオンにすることもできません。</span><span class="sxs-lookup"><span data-stu-id="06e19-158">This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on.</span></span> <span data-ttu-id="06e19-159">変更できないイベントを変更しようとすると、失敗を表す HRESULT が `ICorProfilerInfo::SetEventMask` から返されます。</span><span class="sxs-lookup"><span data-stu-id="06e19-159">Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT.</span></span>  
  
<a name="windows_service"></a>

## <a name="profiling-a-windows-service"></a><span data-ttu-id="06e19-160">Windows サービスのプロファイリング</span><span class="sxs-lookup"><span data-stu-id="06e19-160">Profiling a Windows Service</span></span>  

 <span data-ttu-id="06e19-161">Windows サービスのプロファイリングは、共通言語ランタイム アプリケーションのプロファイリングと同様です。</span><span class="sxs-lookup"><span data-stu-id="06e19-161">Profiling a Windows Service is like profiling a common language runtime application.</span></span> <span data-ttu-id="06e19-162">どちらのプロファイリング操作も環境変数で有効にできます。</span><span class="sxs-lookup"><span data-stu-id="06e19-162">Both profiling operations are enabled through environment variables.</span></span> <span data-ttu-id="06e19-163">Windows サービスはオペレーティング システムの起動時に開始されるため、前の環境変数をあらかじめ作成し、必要な値を設定しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-163">Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts.</span></span> <span data-ttu-id="06e19-164">さらに、プロファイル DLL を事前にシステムに登録しておく必要もあります。</span><span class="sxs-lookup"><span data-stu-id="06e19-164">In addition, the profiling DLL must already be registered on the system.</span></span>  
  
 <span data-ttu-id="06e19-165">環境変数 COR_ENABLE_PROFILING と COR_PROFILER を設定し、プロファイラー DLL を登録したら、これらの変更が Windows サービスで検出されるようにするために、ターゲット コンピューターを再起動してください。</span><span class="sxs-lookup"><span data-stu-id="06e19-165">After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.</span></span>  
  
 <span data-ttu-id="06e19-166">これらの変更を行うと、プロファイリングがシステム全体で有効になります。</span><span class="sxs-lookup"><span data-stu-id="06e19-166">Note that these changes will enable profiling on a system-wide basis.</span></span> <span data-ttu-id="06e19-167">以降に実行するすべてのマネージド アプリケーションがプロファイルされるのを避けるには、ターゲット コンピューターを再起動した後で、システム環境変数を削除します。</span><span class="sxs-lookup"><span data-stu-id="06e19-167">To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.</span></span>  
  
 <span data-ttu-id="06e19-168">この方法では、すべての CLR プロセスもプロファイリングの対象になります。</span><span class="sxs-lookup"><span data-stu-id="06e19-168">This technique also leads to every CLR process getting profiled.</span></span> <span data-ttu-id="06e19-169">プロファイラーは、現在のプロセスが対象であるかどうかを検出するために、 [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) コールバックにロジックを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="06e19-169">The profiler should add logic to its [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest.</span></span> <span data-ttu-id="06e19-170">プロファイリングの対象ではない場合、プロファイラーは、初期化を実行せずにコールバックからエラーを返すことができます。</span><span class="sxs-lookup"><span data-stu-id="06e19-170">If it is not, the profiler can fail the callback without performing the initialization.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="06e19-171">関連項目</span><span class="sxs-lookup"><span data-stu-id="06e19-171">See also</span></span>

- [<span data-ttu-id="06e19-172">プロファイリングの概要</span><span class="sxs-lookup"><span data-stu-id="06e19-172">Profiling Overview</span></span>](profiling-overview.md)
