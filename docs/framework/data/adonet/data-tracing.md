---
description: '詳細情報: ADO.NET のデータ追跡'
title: データのトレース
ms.date: 03/30/2017
ms.assetid: a6a752a5-d2a9-4335-a382-b58690ccb79f
ms.openlocfilehash: 7fc4407e76ea34bacc97177d6342730a8263b5c9
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99663743"
---
# <a name="data-tracing-in-adonet"></a><span data-ttu-id="3a4ae-103">ADO.NET のデータ追跡</span><span class="sxs-lookup"><span data-stu-id="3a4ae-103">Data Tracing in ADO.NET</span></span>

<span data-ttu-id="3a4ae-104">ADO.NET に組み込まれているデータ トレース機能は、SQL Server、Oracle、OLE DB、ODBC 用の .NET データ プロバイダーと、ADO.NET <xref:System.Data.DataSet> および SQL Server ネットワーク プロトコルによりサポートされています。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-104">ADO.NET features built-in data tracing functionality that is supported by the .NET data providers for SQL Server, Oracle, OLE DB and ODBC, as well as the ADO.NET <xref:System.Data.DataSet>, and the SQL Server network protocols.</span></span>

<span data-ttu-id="3a4ae-105">データ アクセス API 呼び出しのトレースは、次の問題を診断する際に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-105">Tracing data access API calls can help diagnose the following problems:</span></span>

- <span data-ttu-id="3a4ae-106">クライアント プログラムとデータベース間のスキーマの不一致</span><span class="sxs-lookup"><span data-stu-id="3a4ae-106">Schema mismatch between client program and the database.</span></span>

- <span data-ttu-id="3a4ae-107">データベースの使用不可またはネットワーク ライブラリの問題</span><span class="sxs-lookup"><span data-stu-id="3a4ae-107">Database unavailability or network library problems.</span></span>

- <span data-ttu-id="3a4ae-108">誤った SQL がアプリケーションによりハードコーディングまたは生成された</span><span class="sxs-lookup"><span data-stu-id="3a4ae-108">Incorrect SQL whether hard coded or generated by an application.</span></span>

- <span data-ttu-id="3a4ae-109">プログラミング ロジックが不適切</span><span class="sxs-lookup"><span data-stu-id="3a4ae-109">Incorrect programming logic.</span></span>

- <span data-ttu-id="3a4ae-110">複数の ADO.NET コンポーネント間または ADO.NET と独自コンポーネント間の対話に起因する問題</span><span class="sxs-lookup"><span data-stu-id="3a4ae-110">Issues resulting from the interaction between multiple ADO.NET components or between ADO.NET and your own components.</span></span>

<span data-ttu-id="3a4ae-111">トレースを拡張することにより異なるトレース技術をサポートできます。このため、開発者はアプリケーション スタックのあらゆるレベルで問題をトレースできます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-111">To support different trace technologies, tracing is extensible, so a developer can trace a problem at any level of the application stack.</span></span> <span data-ttu-id="3a4ae-112">トレースは ADO.NET のみで使用できる機能ではありませんが、Microsoft プロバイダーでは、汎用トレース機能および instrumentation API を活用しています。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-112">Although tracing is not an ADO.NET-only feature, Microsoft providers take advantage of generalized tracing and instrumentation APIs.</span></span>

<span data-ttu-id="3a4ae-113">ADO.NET におけるマネージド トレースの設定と構成について詳しくは、[データ アクセスのトレース](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))に関する記事をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-113">For more information about setting and configuring managed tracing in ADO.NET, see [Tracing Data Access](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10)).</span></span>

## <a name="accessing-diagnostic-information-in-the-extended-events-log"></a><span data-ttu-id="3a4ae-114">拡張イベント ログの診断情報へのアクセス</span><span class="sxs-lookup"><span data-stu-id="3a4ae-114">Accessing Diagnostic Information in the Extended Events Log</span></span>

<span data-ttu-id="3a4ae-115">.NET Framework Data Provider for SQL Server では、拡張イベント ログのサーバーの接続のリング バッファーやアプリケーションのパフォーマンス情報から、接続の障害などのクライアントのイベントを診断情報と関連付けることを容易にするため、データ アクセスのトレース ([データ アクセスのトレース](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))に関する記事を参照) が更新されました。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-115">In the .NET Framework Data Provider for SQL Server, data access tracing ([Data Access Tracing](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) has been updated to make it easier to correlate client events with diagnostic information, such as connection failures, from the server's connectivity ring buffer and application performance information in the extended events log.</span></span> <span data-ttu-id="3a4ae-116">拡張イベント ログを表示する方法については、「[イベント セッション データの表示](/previous-versions/sql/sql-server-2012/hh710068(v=sql.110))」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-116">For information about reading the extended events log, see [View Event Session Data](/previous-versions/sql/sql-server-2012/hh710068(v=sql.110)).</span></span>

<span data-ttu-id="3a4ae-117">接続操作では、ADO.NET はクライアント接続 ID を送信します。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-117">For connection operations, ADO.NET will send a client connection ID.</span></span> <span data-ttu-id="3a4ae-118">接続に失敗した場合は、接続リング バッファー ([接続リング バッファーによる SQL Server 2008 での接続トラブルシューティング](/archive/blogs/sql_protocols/connectivity-troubleshooting-in-sql-server-2008-with-the-connectivity-ring-buffer)に関する記事を参照) にアクセスし、`ClientConnectionID` フィールドを見つけて、接続エラーに関する診断情報を取得することができます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-118">If the connection fails, you can access the connectivity ring buffer ([Connectivity troubleshooting in SQL Server 2008 with the Connectivity Ring Buffer](/archive/blogs/sql_protocols/connectivity-troubleshooting-in-sql-server-2008-with-the-connectivity-ring-buffer)) and find the `ClientConnectionID` field and get diagnostic information about the connection failure.</span></span> <span data-ttu-id="3a4ae-119">クライアント接続 ID は、エラーが発生した場合にのみリング バッファーに記録されます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-119">Client connection IDs are logged in the ring buffer only if an error occurs.</span></span> <span data-ttu-id="3a4ae-120">(ログイン前のパケットを送信する前に接続に失敗した場合、クライアント接続 ID は生成されません。)クライアント接続 ID は 16 バイトの GUID です。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-120">(If a connection fails before sending the prelogin packet, a client connection ID will not be generated.) The client connection ID is a 16-byte GUID.</span></span> <span data-ttu-id="3a4ae-121">拡張イベント セッション内のイベントに `client_connection_id` アクションが追加された場合にも、拡張イベントのターゲット出力のクライアント接続 ID を見つけることができます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-121">You can also find the client connection ID in the extended events target output, if the `client_connection_id` action is added to events in an extended events session.</span></span> <span data-ttu-id="3a4ae-122">それ以上にクライアントのドライバーの診断について支援が必要な場合は、データ アクセスのトレースを有効にし、接続コマンドを再実行して、データ アクセスのトレースの `ClientConnectionID` フィールドを確認することができます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-122">You can enable data access tracing and rerun the connection command and observe the `ClientConnectionID` field in the data access trace, if you need further client driver diagnostic assistance.</span></span>

<span data-ttu-id="3a4ae-123">`SqlConnection.ClientConnectionID` プロパティを使用して、クライアント接続 ID をプログラムによって取得できます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-123">You can get the client connection ID programmatically by using the `SqlConnection.ClientConnectionID` property.</span></span>

<span data-ttu-id="3a4ae-124">`ClientConnectionID` は、正常に接続を確立する <xref:System.Data.SqlClient.SqlConnection> オブジェクトで使用できます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-124">The `ClientConnectionID` is available for a <xref:System.Data.SqlClient.SqlConnection> object that successfully establishes  a connection.</span></span> <span data-ttu-id="3a4ae-125">接続試行が失敗すると、`ClientConnectionID` は `SqlException.ToString` を通じて利用可能になることがあります。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-125">If a connection attempt fails, `ClientConnectionID` may be available via `SqlException.ToString`.</span></span>

<span data-ttu-id="3a4ae-126">ADO.NET は、スレッド固有のアクティビティ ID も送信します。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-126">ADO.NET also sends a thread-specific activity ID.</span></span> <span data-ttu-id="3a4ae-127">TRACK_CAUSALITY オプションが有効な状態でセッションが開始された場合、アクティビティ ID は拡張イベントのセッションでキャプチャされます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-127">The activity ID is captured in the extended events sessions if the sessions are started with the TRACK_CAUSALITY option enabled.</span></span> <span data-ttu-id="3a4ae-128">アクティブな接続のパフォーマンスの問題については、クライアントのデータ アクセスのトレース (`ActivityID` フィールド) からアクティビティ ID を取得した後、その拡張イベントの出力のアクティビティ ID を検索できます。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-128">For performance issues with an active connection, you can get the activity ID from the client's data access trace (`ActivityID` field) and then locate the activity ID in the extended events output.</span></span> <span data-ttu-id="3a4ae-129">拡張イベントのアクティビティ ID は 16 バイトの GUID (クライアント接続 ID の GUID と同じではありません) であり、4 バイトのシーケンス番号が追加されています。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-129">The activity ID in extended events is a 16-byte GUID (not the same as the GUID for the client connection ID) appended with a four-byte sequence number.</span></span> <span data-ttu-id="3a4ae-130">シーケンス番号は、スレッド内で要求の順序を表し、スレッドのバッチと RPC ステートメントの相対的順序を示します。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-130">The sequence number represents the order of a request within a thread and indicates the relative ordering of batch and RPC statements for the thread.</span></span> <span data-ttu-id="3a4ae-131">`ActivityID` は、現在、データ アクセスのトレースが有効な場合、データ アクセスのトレースの構成のワードの 18 番目のビットが有効にされると、オプションとして SQL のバッチ ステートメントと RPC の要求に送信されるようになっています。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-131">The `ActivityID` is currently optionally sent for SQL batch statements and RPC requests when data access tracing is enabled on and the 18th bit in the data access tracing configuration word is turned ON.</span></span>

<span data-ttu-id="3a4ae-132">次に示すのは、リング バッファーに格納され、RPC とバッチ操作でクライアントから送信されるアクティビティ ID を記録する拡張イベントのセッションを開始するために Transact-SQL を使用するサンプルです。</span><span class="sxs-lookup"><span data-stu-id="3a4ae-132">The following is a sample that uses Transact-SQL to start an extended events session that will be stored in a ring buffer and will record the activity ID sent from a client on RPC and batch operations.</span></span>

```sql
create event session MySession on server
add event connectivity_ring_buffer_recorded,
add event sql_statement_starting (action (client_connection_id)),
add event sql_statement_completed (action (client_connection_id)),
add event rpc_starting (action (client_connection_id)),
add event rpc_completed (action (client_connection_id))
add target ring_buffer with (track_causality=on)
```

## <a name="see-also"></a><span data-ttu-id="3a4ae-133">関連項目</span><span class="sxs-lookup"><span data-stu-id="3a4ae-133">See also</span></span>

- [<span data-ttu-id="3a4ae-134">.NET Framework のネットワークのトレース</span><span class="sxs-lookup"><span data-stu-id="3a4ae-134">Network Tracing in the .NET Framework</span></span>](../../network-programming/network-tracing.md)
- [<span data-ttu-id="3a4ae-135">アプリケーションのトレースとインストルメント</span><span class="sxs-lookup"><span data-stu-id="3a4ae-135">Tracing and Instrumenting Applications</span></span>](../../debug-trace-profile/tracing-and-instrumenting-applications.md)
- [<span data-ttu-id="3a4ae-136">ADO.NET の概要</span><span class="sxs-lookup"><span data-stu-id="3a4ae-136">ADO.NET Overview</span></span>](ado-net-overview.md)
