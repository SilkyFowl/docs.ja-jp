---
description: 詳細については、「有害メッセージの処理」を参照してください。
title: 有害メッセージ処理
ms.date: 03/30/2017
ms.assetid: 8d1c5e5a-7928-4a80-95ed-d8da211b8595
ms.openlocfilehash: 1d6c8027d44da4d79562e4e427654a3d85df3e88
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99793624"
---
# <a name="poison-message-handling"></a><span data-ttu-id="2e5e0-103">有害メッセージ処理</span><span class="sxs-lookup"><span data-stu-id="2e5e0-103">Poison Message Handling</span></span>

<span data-ttu-id="2e5e0-104">*有害なメッセージ* とは、アプリケーションへの配信試行の最大回数を超えたことを示すメッセージのことです。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-104">A *poison message* is a message that has exceeded the maximum number of delivery attempts to the application.</span></span> <span data-ttu-id="2e5e0-105">この状況は、キュー ベースのアプリケーションがエラーによってメッセージを処理できないときに発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-105">This situation can arise when a queue-based application cannot process a message because of errors.</span></span> <span data-ttu-id="2e5e0-106">信頼性に対する要求を満たすために、キューに置かれたアプリケーションはトランザクションの下でメッセージを受信します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-106">To meet reliability demands, a queued application receives messages under a transaction.</span></span> <span data-ttu-id="2e5e0-107">キューに置かれたメッセージを受信したトランザクションを中止すると、メッセージはそのままキューに残り、新しいトランザクションの下で再試行されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-107">Aborting the transaction in which a queued message was received leaves the message in the queue so that the message is retried under a new transaction.</span></span> <span data-ttu-id="2e5e0-108">トランザクションを中止させた問題が解決されなければ、受信側のアプリケーションは、配信試行回数の最大値を超えるまで同じメッセージの受信と中止を繰り返す悪循環に陥る可能性があり、その結果、有害メッセージが生じることになります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-108">If the problem that caused the transaction to abort is not corrected, the receiving application can get stuck in a loop receiving and aborting the same message until the maximum number of delivery attempts has been exceeded and a poison message results.</span></span>  
  
 <span data-ttu-id="2e5e0-109">メッセージは、さまざまな理由で有害メッセージになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-109">A message can become a poison message for many reasons.</span></span> <span data-ttu-id="2e5e0-110">最も一般的な理由は、アプリケーションによって異なります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-110">The most common reasons are application-specific.</span></span> <span data-ttu-id="2e5e0-111">たとえば、アプリケーションがキューからメッセージを読み取り、なんらかのデータベース処理を実行する場合は、アプリケーションがデータベースをロックできないことによって、トランザクションが中止されることが考えられます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-111">For example, if an application reads a message from a queue and performs some database processing, the application may fail to get a lock on the database, causing it to abort the transaction.</span></span> <span data-ttu-id="2e5e0-112">データベース トランザクションが中止されたために、メッセージはキューに残ります。これにより、アプリケーションではメッセージを再度読み取り、データベースのロックの取得を再試行します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-112">Because the database transaction was aborted, the message remains in the queue, which causes the application to reread the message a second time and make another attempt to acquire a lock on the database.</span></span> <span data-ttu-id="2e5e0-113">メッセージに無効な情報が含まれている場合にも、有害メッセージになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-113">Messages can also become poison if they contain invalid information.</span></span> <span data-ttu-id="2e5e0-114">たとえば、発注書に無効な顧客番号が含まれている場合があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-114">For example, a purchase order may contain an invalid customer number.</span></span> <span data-ttu-id="2e5e0-115">このような場合、アプリケーションは自発的にトランザクションを中止し、メッセージを強制的に有害メッセージにすることがあります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-115">In these cases, the application may voluntarily abort the transaction and force the message to become a poison message.</span></span>  
  
 <span data-ttu-id="2e5e0-116">まれに、メッセージをアプリケーションにディスパッチできないことがあります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-116">On rare occasions, messages can fail to get dispatched to the application.</span></span> <span data-ttu-id="2e5e0-117">メッセージに間違ったフレームが含まれている、無効なメッセージ資格情報が添付されている、無効なアクションヘッダーなど、メッセージに問題がある場合は、Windows Communication Foundation (WCF) レイヤーによってメッセージに問題が発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-117">The Windows Communication Foundation (WCF) layer may find a problem with the message, such as if the message has the wrong frame, invalid message credentials attached to it, or an invalid action header.</span></span> <span data-ttu-id="2e5e0-118">このような場合、アプリケーションはメッセージを受信しません。ただし、メッセージは有害メッセージとなるため、手動で処理できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-118">In these cases, the application never receives the message; however, the message can still become a poison message and be processed manually.</span></span>  
  
## <a name="handling-poison-messages"></a><span data-ttu-id="2e5e0-119">有害メッセージの処理</span><span class="sxs-lookup"><span data-stu-id="2e5e0-119">Handling Poison Messages</span></span>  

 <span data-ttu-id="2e5e0-120">WCF では、有害メッセージの処理によって、アプリケーションにディスパッチできないメッセージやアプリケーションにディスパッチされても、アプリケーション固有の理由により処理に失敗したメッセージを受信側のアプリケーションが処理するメカニズムが提供されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-120">In WCF, poison message handling provides a mechanism for a receiving application to deal with messages that cannot be dispatched to the application or messages that are dispatched to the application but that fail to be processed because of application-specific reasons.</span></span> <span data-ttu-id="2e5e0-121">使用可能なキューに置かれている各バインドで、次のプロパティを使用して有害メッセージの処理を構成します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-121">Configure poison message handling with the following properties in each of the available queued bindings:</span></span>  
  
- <span data-ttu-id="2e5e0-122">`ReceiveRetryCount`.</span><span class="sxs-lookup"><span data-stu-id="2e5e0-122">`ReceiveRetryCount`.</span></span> <span data-ttu-id="2e5e0-123">アプリケーション キューからアプリケーションへのメッセージの配信を再試行する最大回数を示す整数値。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-123">An integer value that indicates the maximum number of times to retry delivery of a message from the application queue to the application.</span></span> <span data-ttu-id="2e5e0-124">既定値は 5 です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-124">The default value is 5.</span></span> <span data-ttu-id="2e5e0-125">データベースの一時的なデッドロックなどの問題を即時再試行で解決する場合は、この値で十分です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-125">This is sufficient in cases where an immediate retry fixes the problem, such as with a temporary deadlock on a database.</span></span>  
  
- <span data-ttu-id="2e5e0-126">`MaxRetryCycles`.</span><span class="sxs-lookup"><span data-stu-id="2e5e0-126">`MaxRetryCycles`.</span></span> <span data-ttu-id="2e5e0-127">再試行サイクルの最大数を示す整数値。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-127">An integer value that indicates the maximum number of retry cycles.</span></span> <span data-ttu-id="2e5e0-128">再試行サイクルは、アプリケーション キューから再試行サブキューにメッセージを転送し、構成可能な遅延の後に再試行サブキューからアプリケーション キューにメッセージを転送して配信を再試行するプロセスで構成されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-128">A retry cycle consists of transferring a message from the application queue to the retry subqueue and, after a configurable delay, from the retry subqueue back into the application queue to reattempt delivery.</span></span> <span data-ttu-id="2e5e0-129">既定値は 2 です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-129">The default value is 2.</span></span> <span data-ttu-id="2e5e0-130">Windows Vista では、メッセージは最大で ( `ReceiveRetryCount` + 1) \* ( `MaxRetryCycles` + 1) 回試行されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-130">On Windows Vista, the message is tried a maximum of (`ReceiveRetryCount` +1) \* (`MaxRetryCycles` + 1) times.</span></span> <span data-ttu-id="2e5e0-131">`MaxRetryCycles` Windows Server 2003 および Windows XP では、は無視されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-131">`MaxRetryCycles` is ignored on Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="2e5e0-132">`RetryCycleDelay`.</span><span class="sxs-lookup"><span data-stu-id="2e5e0-132">`RetryCycleDelay`.</span></span> <span data-ttu-id="2e5e0-133">再試行サイクル間の遅延時間。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-133">The time delay between retry cycles.</span></span> <span data-ttu-id="2e5e0-134">既定値は 30 分です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-134">The default value is 30 minutes.</span></span> <span data-ttu-id="2e5e0-135">`MaxRetryCycles` と `RetryCycleDelay` の組み合わせにより、問題に対処する機構が提供されます。この場合、定期的な遅延後に再試行が行われ、問題が解決されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-135">`MaxRetryCycles` and `RetryCycleDelay` together provide a mechanism to address the problem where a retry after a periodic delay fixes the problem.</span></span> <span data-ttu-id="2e5e0-136">たとえば、SQL Server の保留中のトランザクションのコミットでロックされた行セットが処理されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-136">For example, this handles a locked row set in SQL Server pending transaction commit.</span></span>  
  
- <span data-ttu-id="2e5e0-137">`ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="2e5e0-137">`ReceiveErrorHandling`.</span></span> <span data-ttu-id="2e5e0-138">再試行を最大回数実行しても配信できなかったメッセージに対して実行するアクションを示す列挙値。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-138">An enumeration that indicates the action to take for a message that has failed delivery after the maximum number of retries has been attempted.</span></span> <span data-ttu-id="2e5e0-139">値には、Fault、Drop、Reject、および Move の 4 つがあります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-139">The values can be Fault, Drop, Reject, and Move.</span></span> <span data-ttu-id="2e5e0-140">既定のオプションは Fault です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-140">The default option is Fault.</span></span>  
  
- <span data-ttu-id="2e5e0-141">Fault : </span><span class="sxs-lookup"><span data-stu-id="2e5e0-141">Fault.</span></span> <span data-ttu-id="2e5e0-142">このオプションでは、`ServiceHost` のエラーの原因となったリスナーにエラーが送信されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-142">This option sends a fault to the listener that caused the `ServiceHost` to fault.</span></span> <span data-ttu-id="2e5e0-143">アプリケーションでキューのメッセージの処理を継続するには、なんらかの外部機構によってアプリケーション キューからメッセージを削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-143">The message must be removed from the application queue by some external mechanism before the application can continue to process messages from the queue.</span></span>  
  
- <span data-ttu-id="2e5e0-144">Drop : </span><span class="sxs-lookup"><span data-stu-id="2e5e0-144">Drop.</span></span> <span data-ttu-id="2e5e0-145">このオプションでは、有害メッセージが破棄されます。メッセージがアプリケーションに配信されることはありません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-145">This option drops the poison message and the message is never delivered to the application.</span></span> <span data-ttu-id="2e5e0-146">この時点でメッセージの `TimeToLive` プロパティの有効期限が既に切れている場合は、メッセージが送信側の配信不能キューに表示されることがあります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-146">If the message's `TimeToLive` property has expired at this point, then the message may appear in the sender's dead-letter queue.</span></span> <span data-ttu-id="2e5e0-147">有効期限が切れていない場合は、どこにも表示されません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-147">If not, the message does not appear anywhere.</span></span> <span data-ttu-id="2e5e0-148">このオプションは、メッセージが失われたときにユーザーが実行する操作が指定されていないことを示します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-148">This option indicates that the user has not specified what to do if the message is lost.</span></span>  
  
- <span data-ttu-id="2e5e0-149">Reject : </span><span class="sxs-lookup"><span data-stu-id="2e5e0-149">Reject.</span></span> <span data-ttu-id="2e5e0-150">このオプションは、Windows Vista でのみ使用できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-150">This option is available only on Windows Vista.</span></span> <span data-ttu-id="2e5e0-151">これにより、メッセージキュー (MSMQ) は、メッセージを受信できないという否定受信確認を送信キューマネージャーに返信するように指示します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-151">This instructs Message Queuing (MSMQ) to send a negative acknowledgment back to the sending queue manager that the application cannot receive the message.</span></span> <span data-ttu-id="2e5e0-152">メッセージは、送信側キュー マネージャーの配信不能キューに置かれます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-152">The message is placed in the sending queue manager's dead-letter queue.</span></span>  
  
- <span data-ttu-id="2e5e0-153">Move : </span><span class="sxs-lookup"><span data-stu-id="2e5e0-153">Move.</span></span> <span data-ttu-id="2e5e0-154">このオプションは、Windows Vista でのみ使用できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-154">This option is available only on Windows Vista.</span></span> <span data-ttu-id="2e5e0-155">有害メッセージを有害メッセージ キューに移動して、後で有害メッセージ処理アプリケーションで処理できるようにします。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-155">This moves the poison message to a poison-message queue for later processing by a poison-message handling application.</span></span> <span data-ttu-id="2e5e0-156">有害メッセージ キューは、アプリケーション キューのサブキューです。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-156">The poison-message queue is a subqueue of the application queue.</span></span> <span data-ttu-id="2e5e0-157">有害メッセージ処理アプリケーションは、有害キューからメッセージを読み取る WCF サービスにすることができます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-157">A poison-message handling application can be a WCF service that reads messages out of the poison queue.</span></span> <span data-ttu-id="2e5e0-158">有害キューはアプリケーションキューのサブキューであり、oison://applicationqueue queue としてアドレス指定できます。ここで、 \<*machine-name*> / *コンピューター名* はキューが存在するコンピューターの名前、 *applicationqueue* はアプリケーション固有のキューの名前です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-158">The poison queue is a subqueue of the application queue and can be addressed as net.msmq://\<*machine-name*>/*applicationQueue*;poison, where *machine-name* is the name of the computer on which the queue resides and the *applicationQueue* is the name of the application-specific queue.</span></span>  
  
<span data-ttu-id="2e5e0-159">メッセージに対して実行される配信の最大試行回数は、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-159">The following are the maximum number of delivery attempts made for a message:</span></span>  
  
- <span data-ttu-id="2e5e0-160">((ReceiveRetryCount + 1) \* (MaxRetryCycles + 1)) (Windows Vista の場合)。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-160">((ReceiveRetryCount+1) \* (MaxRetryCycles + 1)) on Windows Vista.</span></span>  
  
- <span data-ttu-id="2e5e0-161">(ReceiveRetryCount + 1) (Windows Server 2003 および Windows XP の場合)。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-161">(ReceiveRetryCount + 1) on Windows Server 2003 and Windows XP.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="2e5e0-162">正常に配信されたメッセージについては、再試行は行われません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-162">No retries are made for a message that is delivered successfully.</span></span>  
  
 <span data-ttu-id="2e5e0-163">メッセージの読み取りが試行された回数を追跡するために、Windows Vista は、中断の回数と、アプリケーションキューとサブキューの間でメッセージが移動する回数をカウントする "移動数" プロパティを保持します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-163">To keep track of the number of times a message read is attempted, Windows Vista maintains a durable message property that counts the number of aborts and a move count property that counts the number of times the message moves between the application queue and subqueues.</span></span> <span data-ttu-id="2e5e0-164">WCF チャネルはこれらを使用して、受信再試行回数と再試行サイクル数を計算します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-164">The WCF channel uses these to compute the receive retry count and the retry cycles count.</span></span> <span data-ttu-id="2e5e0-165">Windows Server 2003 および Windows XP では、abort カウントは WCF チャネルによってメモリ内に保持され、アプリケーションが失敗した場合はリセットされます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-165">On Windows Server 2003 and Windows XP, the abort count is maintained in memory by the WCF channel and is reset if the application fails.</span></span> <span data-ttu-id="2e5e0-166">また、WCF チャネルは、最大256のメッセージの中止回数をメモリ内でいつでも保持できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-166">Also, the WCF channel can hold the abort counts for up to 256 messages in memory at any time.</span></span> <span data-ttu-id="2e5e0-167">257 番目のメッセージを読み取ると、最も古いメッセージの中止回数がリセットされます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-167">If a 257th message is read, then the oldest message's abort count is reset.</span></span>  
  
 <span data-ttu-id="2e5e0-168">中止回数と移動回数のプロパティは、操作コンテキストを通じてサービス操作で使用できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-168">The abort count and move count properties are available to the service operation through the operation context.</span></span> <span data-ttu-id="2e5e0-169">これらのプロパティにアクセスする方法を次のコード例に示します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-169">The following code example shows how to access them.</span></span>  
  
 [!code-csharp[S_UE_MSMQ_Poison#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/service.cs#1)]  
  
 <span data-ttu-id="2e5e0-170">WCF には、2つの標準キューバインドが用意されています。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-170">WCF provides two standard queued bindings:</span></span>  
  
- <span data-ttu-id="2e5e0-171"><xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="2e5e0-171"><xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="2e5e0-172">他の WCF エンドポイントとのキューベースの通信を実行するのに適した .NET Framework バインディング。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-172">A .NET Framework binding suitable for performing queue-based communication with other WCF endpoints.</span></span>  
  
- <span data-ttu-id="2e5e0-173"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span><span class="sxs-lookup"><span data-stu-id="2e5e0-173"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span></span> <span data-ttu-id="2e5e0-174">既存のメッセージ キュー アプリケーションとの通信に適したバインディング。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-174">A binding suitable for communicating with existing Message Queuing applications.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="2e5e0-175">これらのバインドのプロパティは、WCF サービスの要件に基づいて変更できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-175">You can alter properties in these bindings based on the requirements of your WCF service.</span></span> <span data-ttu-id="2e5e0-176">有害メッセージ処理機構全体は、受信側アプリケーションに対してローカルです。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-176">The entire poison message handling mechanism is local to the receiving application.</span></span> <span data-ttu-id="2e5e0-177">このプロセスは、受信側アプリケーションが最終的に処理を停止し、送信側に否定受信確認を返信する場合を除き、送信元アプリケーションには認識されません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-177">The process is invisible to the sending application unless the receiving application ultimately stops and sends a negative acknowledgment back to the sender.</span></span> <span data-ttu-id="2e5e0-178">この場合、メッセージは、送信元の配信不能キューに送られます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-178">In that case, the message is moved to the sender's dead-letter queue.</span></span>  
  
## <a name="best-practice-handling-msmqpoisonmessageexception"></a><span data-ttu-id="2e5e0-179">ベスト プラクティス : MsmqPoisonMessageException の処理</span><span class="sxs-lookup"><span data-stu-id="2e5e0-179">Best Practice: Handling MsmqPoisonMessageException</span></span>  

 <span data-ttu-id="2e5e0-180">メッセージが有害であるとサービスが判断した場合、キューに置かれたトランスポートは <xref:System.ServiceModel.MsmqPoisonMessageException> をスローします。この例外には、有害メッセージの `LookupId` が含まれます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-180">When the service determines that a message is poison, the queued transport throws a <xref:System.ServiceModel.MsmqPoisonMessageException> that contains the `LookupId` of the poison message.</span></span>  
  
 <span data-ttu-id="2e5e0-181">受信側アプリケーションでは、必要な <xref:System.ServiceModel.Dispatcher.IErrorHandler> インターフェイスを実装して、すべてのエラーを処理できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-181">A receiving application can implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to handle any errors that the application requires.</span></span> <span data-ttu-id="2e5e0-182">詳細については、「 [エラー処理およびレポートに対する制御の拡張](../samples/extending-control-over-error-handling-and-reporting.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-182">For more information, see [Extending Control Over Error Handling and Reporting](../samples/extending-control-over-error-handling-and-reporting.md).</span></span>  
  
 <span data-ttu-id="2e5e0-183">アプリケーションでは、有害メッセージを有害メッセージ キューに移動し、サービスがキュー内の残りのメッセージにアクセスできるようにする、なんらかの有害メッセージ自動処理を必要とする場合があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-183">The application may require some kind of automated handling of poison messages that moves the poison messages to a poison message queue so that the service can access the rest of the messages in the queue.</span></span> <span data-ttu-id="2e5e0-184">エラー処理機構を使用して有害メッセージの例外をリッスンする唯一のシナリオは、<xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> の設定を <xref:System.ServiceModel.ReceiveErrorHandling.Fault> に設定した場合です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-184">The only scenario for using the error-handler mechanism to listen for poison-message exceptions is when the <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> setting is set to <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span></span> <span data-ttu-id="2e5e0-185">メッセージ キュー 3.0 の有害メッセージ サンプルは、この動作を示しています。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-185">The poison-message sample for Message Queuing 3.0 demonstrates this behavior.</span></span> <span data-ttu-id="2e5e0-186">ベスト プラクティスを含め、有害メッセージを処理するために必要な手順の概要を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-186">The following outlines the steps to take to handle poison messages, including best practices:</span></span>  
  
1. <span data-ttu-id="2e5e0-187">有害メッセージの設定がアプリケーションの要件を反映していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-187">Ensure your poison settings reflect the requirements of your application.</span></span> <span data-ttu-id="2e5e0-188">設定を使用する場合は、Windows Vista、Windows Server 2003、および Windows XP でのメッセージキューの機能の違いを理解しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-188">When working with the settings, ensure that you understand the differences between the capabilities of Message Queuing on Windows Vista, Windows Server 2003, and Windows XP.</span></span>  
  
2. <span data-ttu-id="2e5e0-189">必要に応じて、を実装して `IErrorHandler` 有害メッセージエラーを処理します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-189">If necessary, implement the `IErrorHandler` to handle poison-message errors.</span></span> <span data-ttu-id="2e5e0-190">`ReceiveErrorHandling` を `Fault` に設定する場合、有害メッセージをキューから取り除いたり、外部の従属的な問題を解決したりする手動の機構が必要となります。そのため、`IErrorHandler` を `ReceiveErrorHandling` に設定するときは、次のコードに示すように `Fault` を実装するのが一般的です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-190">Because setting `ReceiveErrorHandling` to `Fault` requires a manual mechanism to move the poison message out of the queue or to correct an external dependent issue, the typical usage is to implement `IErrorHandler` when `ReceiveErrorHandling` is set to `Fault`, as shown in the following code.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonerrorhandler.cs#2)]  
  
3. <span data-ttu-id="2e5e0-191">サービス動作が使用できる `PoisonBehaviorAttribute` を作成します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-191">Create a `PoisonBehaviorAttribute` that the service behavior can use.</span></span> <span data-ttu-id="2e5e0-192">この動作により、`IErrorHandler` がディスパッチャーにインストールされます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-192">The behavior installs the `IErrorHandler` on the dispatcher.</span></span> <span data-ttu-id="2e5e0-193">このコード例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-193">See the following code example.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonbehaviorattribute.cs#3)]  
  
4. <span data-ttu-id="2e5e0-194">サービスに有害動作属性による注釈が付けられていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-194">Ensure that your service is annotated with the poison behavior attribute.</span></span>  

 <span data-ttu-id="2e5e0-195">また、`ReceiveErrorHandling` を `Fault` に設定した場合は、`ServiceHost` が有害メッセージを検出するとエラーになります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-195">In addition, if the `ReceiveErrorHandling` is set to `Fault`, the `ServiceHost` faults when encountering the poison message.</span></span> <span data-ttu-id="2e5e0-196">この場合、faulted イベントにフックしてサービスを終了し、是正措置を講じた後に再起動できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-196">You can hook up to the faulted event and shut down the service, take corrective actions, and restart.</span></span> <span data-ttu-id="2e5e0-197">たとえば、`LookupId` に伝達された <xref:System.ServiceModel.MsmqPoisonMessageException> に含まれる `IErrorHandler` は記録しておくことができます。そのため、サービス ホストでエラーが発生したときに、`System.Messaging` API を使用して、この `LookupId` に基づいてキューからメッセージを受信し、そのメッセージをキューから削除して、外部ストアまたは別のキューに格納できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-197">For example, the `LookupId` in the <xref:System.ServiceModel.MsmqPoisonMessageException> propagated to the `IErrorHandler` can be noted and when the service host faults, you could use the `System.Messaging` API to receive the message from the queue using the `LookupId` to remove the message from the queue and store the message in some external store or another queue.</span></span> <span data-ttu-id="2e5e0-198">これで `ServiceHost` を再起動して、通常の処理を再開できるようになります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-198">You can then restart `ServiceHost` to resume normal processing.</span></span> <span data-ttu-id="2e5e0-199">[MSMQ 4.0 での有害メッセージ処理](../samples/poison-message-handling-in-msmq-4-0.md)は、この動作を示しています。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-199">The [Poison Message Handling in MSMQ 4.0](../samples/poison-message-handling-in-msmq-4-0.md) demonstrates this behavior.</span></span>  
  
## <a name="transaction-time-out-and-poison-messages"></a><span data-ttu-id="2e5e0-200">トランザクション タイムアウトと有害メッセージ</span><span class="sxs-lookup"><span data-stu-id="2e5e0-200">Transaction Time-Out and Poison Messages</span></span>  

 <span data-ttu-id="2e5e0-201">キューに置かれたトランスポート チャネルとユーザー コードの間では、特定の部類のエラーが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-201">A class of errors can occur between the queued transport channel and the user code.</span></span> <span data-ttu-id="2e5e0-202">これらのエラーは、メッセージ セキュリティ レイヤーやサービス ディスパッチ ロジックなど、中間のレイヤーで検出される場合があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-202">These errors can be detected by layers in-between, such as the message security layer or the service dispatching logic.</span></span> <span data-ttu-id="2e5e0-203">たとえば、SOAP セキュリティ レイヤーで X.509 証明書がないことが検出された場合やアクションがない場合は、メッセージがアプリケーションにディスパッチされます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-203">For example, a missing X.509 certificate detected in the SOAP security layer and a missing action are cases where the message does get dispatched to the application.</span></span> <span data-ttu-id="2e5e0-204">この場合、サービス モデルはそのメッセージを破棄します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-204">When this happens, the service model drops the message.</span></span> <span data-ttu-id="2e5e0-205">メッセージはトランザクションで読み取られますが、そのトランザクションの結果は提供されないため、トランザクションが最終的にタイムアウトになって中止され、メッセージはキューに戻されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-205">Because the message is read in a transaction and an outcome for that transaction cannot be provided, the transaction eventually times out, aborts, and the message is put back into the queue.</span></span> <span data-ttu-id="2e5e0-206">つまり、エラーの特定のクラスについては、トランザクションがすぐに中止されるのではなく、トランザクションがタイムアウトするまで待機します。サービスのトランザクションタイムアウトは、を使用して変更でき <xref:System.ServiceModel.ServiceBehaviorAttribute> ます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-206">In other words, for a certain class of errors, the transaction does not immediately abort but waits until the transaction times out. You can modify the transaction time-out for a service using <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span></span>  
  
 <span data-ttu-id="2e5e0-207">コンピューター全体のトランザクションタイムアウトを変更するには、machine.config ファイルを変更し、適切なトランザクションタイムアウトを設定します。トランザクションで設定されたタイムアウトによっては、トランザクションが最終的に中止されてキューに戻され、その中止回数が増加することに注意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-207">To change the transaction time-out on a computer-wide basis, modify the machine.config file and set the appropriate transaction time-out. It is important to note that, depending on the time-out set in the transaction, the transaction eventually aborts and goes back to the queue and its abort count is incremented.</span></span> <span data-ttu-id="2e5e0-208">最終的に、メッセージは有害メッセージになり、ユーザー設定に従って適切な処理が行われます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-208">Eventually, the message becomes poison and the right disposition is made according to the user settings.</span></span>  
  
## <a name="sessions-and-poison-messages"></a><span data-ttu-id="2e5e0-209">セッションと有害メッセージ</span><span class="sxs-lookup"><span data-stu-id="2e5e0-209">Sessions and Poison Messages</span></span>  

 <span data-ttu-id="2e5e0-210">セッションでは、単一のメッセージと同じ再試行および有害メッセージ処理手順が行われます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-210">A session undergoes the same retry and poison-message handling procedures as a single message.</span></span> <span data-ttu-id="2e5e0-211">有害メッセージに対する上記のプロパティは、セッション全体に適用されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-211">The properties previously listed for poison messages apply to the entire session.</span></span> <span data-ttu-id="2e5e0-212">つまり、セッション全体が再試行され、メッセージは最終有害メッセージ キューに送られます。または、メッセージが拒否された場合は、送信側の配信不能キューに送られます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-212">This means that the entire session is retried and goes to a final poison-message queue or the sender’s dead-letter queue if the message is rejected.</span></span>  
  
## <a name="batching-and-poison-messages"></a><span data-ttu-id="2e5e0-213">バッチ処理と有害メッセージ</span><span class="sxs-lookup"><span data-stu-id="2e5e0-213">Batching and Poison Messages</span></span>  

 <span data-ttu-id="2e5e0-214">バッチの一部であるメッセージが有害メッセージになった場合は、バッチ全体がロールバックされ、チャネルはメッセージを 1 つずつ読み取る処理に戻ります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-214">If a message becomes a poison message and is part of a batch, then the entire batch is rolled back and the channel returns to reading one message at a time.</span></span> <span data-ttu-id="2e5e0-215">バッチ処理の詳細については、「[トランザクション内のメッセージのバッチ](batching-messages-in-a-transaction.md)処理」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-215">For more information about batching, see [Batching Messages in a Transaction](batching-messages-in-a-transaction.md)</span></span>  
  
## <a name="poison-message-handling-for-messages-in-a-poison-queue"></a><span data-ttu-id="2e5e0-216">有害キュー内のメッセージに対する有害メッセージ処理</span><span class="sxs-lookup"><span data-stu-id="2e5e0-216">Poison-message Handling for Messages in a Poison Queue</span></span>  

 <span data-ttu-id="2e5e0-217">有害メッセージ処理は、メッセージが有害メッセージ キューに配置された時点では終了しません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-217">Poison-message handling does not end when a message is placed in the poison-message queue.</span></span> <span data-ttu-id="2e5e0-218">有害メッセージ キューに置かれたメッセージは、依然として読み取り、処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-218">Messages in the poison-message queue must still be read and handled.</span></span> <span data-ttu-id="2e5e0-219">最終有害サブキューからメッセージを読み取るときは、有害メッセージ処理設定のサブセットを使用できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-219">You can use a subset of the poison-message handling settings when reading messages from the final poison subqueue.</span></span> <span data-ttu-id="2e5e0-220">適用できる設定は、`ReceiveRetryCount` と `ReceiveErrorHandling` です。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-220">The applicable settings are `ReceiveRetryCount` and `ReceiveErrorHandling`.</span></span> <span data-ttu-id="2e5e0-221">`ReceiveErrorHandling` は Drop、Rreject、Fault のいずれかに設定できます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-221">You can set `ReceiveErrorHandling` to Drop, Reject, or Fault.</span></span> <span data-ttu-id="2e5e0-222">`MaxRetryCycles` が Move に設定されている場合は、`ReceiveErrorHandling` が無視され、例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-222">`MaxRetryCycles` is ignored and an exception is thrown if `ReceiveErrorHandling` is set to Move.</span></span>  
  
## <a name="windows-vista-windows-server-2003-and-windows-xp-differences"></a><span data-ttu-id="2e5e0-223">Windows Vista、Windows Server 2003、および Windows XP の相違点</span><span class="sxs-lookup"><span data-stu-id="2e5e0-223">Windows Vista, Windows Server 2003, and Windows XP Differences</span></span>  

 <span data-ttu-id="2e5e0-224">前述のように、有害メッセージの処理のすべての設定が Windows Server 2003 および Windows XP に適用されるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-224">As noted earlier, not all poison-message handling settings apply to Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="2e5e0-225">Windows Server 2003、Windows XP、および Windows Vista のメッセージキューの主な相違点は、有害メッセージの処理に関連しています。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-225">The following key differences between Message Queuing on Windows Server 2003, Windows XP, and Windows Vista are relevant to poison-message handling:</span></span>  
  
- <span data-ttu-id="2e5e0-226">Windows Vista のメッセージキューは、サブキューをサポートします。一方、Windows Server 2003 および Windows XP では、サブキューはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-226">Message Queuing in Windows Vista supports subqueues, while Windows Server 2003 and Windows XP do not support subqueues.</span></span> <span data-ttu-id="2e5e0-227">サブキューは、有害メッセージ処理で使用されます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-227">Subqueues are used in poison-message handling.</span></span> <span data-ttu-id="2e5e0-228">再試行キューと有害キューは、有害メッセージ処理の設定に基づいて作成されるアプリケーション キューのサブキューです。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-228">The retry queues and the poison queue are subqueues to the application queue that is created based on the poison-message handling settings.</span></span> <span data-ttu-id="2e5e0-229">作成する再試行サブキューの数は、`MaxRetryCycles` で指定します。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-229">The `MaxRetryCycles` dictates how many retry subqueues to create.</span></span> <span data-ttu-id="2e5e0-230">このため、Windows Server 2003 または Windows XP で実行している場合、は無視され、許可され `MaxRetryCycles` `ReceiveErrorHandling.Move` ません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-230">Therefore, when running on Windows Server 2003 or Windows XP, `MaxRetryCycles` are ignored and `ReceiveErrorHandling.Move` is not allowed.</span></span>  
  
- <span data-ttu-id="2e5e0-231">Windows Vista のメッセージキューは否定受信確認をサポートしていますが、Windows Server 2003 および Windows XP ではサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-231">Message Queuing in Windows Vista supports negative acknowledgment, while Windows Server 2003 and Windows XP do not.</span></span> <span data-ttu-id="2e5e0-232">受信側キュー マネージャーから否定受信確認を受け取ると、送信側キュー マネージャーは拒否されたメッセージを配信不能キューに入れます。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-232">A negative acknowledgment from the receiving queue manager causes the sending queue manager to place the rejected message in the dead-letter queue.</span></span> <span data-ttu-id="2e5e0-233">そのため、 `ReceiveErrorHandling.Reject` Windows Server 2003 および WINDOWS XP では使用できません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-233">As such, `ReceiveErrorHandling.Reject` is not allowed with Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="2e5e0-234">Windows Vista のメッセージキューは、メッセージの配信が試行された回数を保持するメッセージプロパティをサポートしています。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-234">Message Queuing in Windows Vista supports a message property that keeps count of the number of times message delivery is attempted.</span></span> <span data-ttu-id="2e5e0-235">この中止回数のプロパティは、Windows Server 2003 および Windows XP では使用できません。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-235">This abort count property is not available on Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="2e5e0-236">WCF では、中止回数がメモリ内に保持されるため、同じメッセージがファーム内の複数の WCF サービスによって読み取られる場合、このプロパティに正確な値が含まれていない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2e5e0-236">WCF maintains the abort count in memory, so it is possible that this property may not contain an accurate value when the same message is read by more than one WCF service in a farm.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2e5e0-237">関連項目</span><span class="sxs-lookup"><span data-stu-id="2e5e0-237">See also</span></span>

- [<span data-ttu-id="2e5e0-238">キューの概要</span><span class="sxs-lookup"><span data-stu-id="2e5e0-238">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="2e5e0-239">Windows Vista、Windows Server 2003、および Windows XP におけるキュー機能の相違点</span><span class="sxs-lookup"><span data-stu-id="2e5e0-239">Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP</span></span>](diff-in-queue-in-vista-server-2003-windows-xp.md)
- [<span data-ttu-id="2e5e0-240">コントラクトおよびサービスのエラーの指定と処理</span><span class="sxs-lookup"><span data-stu-id="2e5e0-240">Specifying and Handling Faults in Contracts and Services</span></span>](../specifying-and-handling-faults-in-contracts-and-services.md)
