---
description: '詳細情報: WCF のセキュリティに関するベストプラクティス'
title: WCF のセキュリティのベスト プラクティス
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- best practices [WCF], security
ms.assetid: 3639de41-1fa7-4875-a1d7-f393e4c8bd69
ms.openlocfilehash: 67c3f3054011ea5727d5713c1eabf810a4c39b42
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99643645"
---
# <a name="best-practices-for-security-in-wcf"></a><span data-ttu-id="319fd-103">WCF のセキュリティのベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="319fd-103">Best Practices for Security in WCF</span></span>

<span data-ttu-id="319fd-104">以下のセクションでは、Windows Communication Foundation (WCF) を使用してセキュリティで保護されたアプリケーションを作成する場合に考慮する必要のあるベスト プラクティスを示します。</span><span class="sxs-lookup"><span data-stu-id="319fd-104">The following sections list the best practices to consider when creating secure applications using Windows Communication Foundation (WCF).</span></span> <span data-ttu-id="319fd-105">セキュリティの詳細については、[セキュリティ上の考慮事項](security-considerations-in-wcf.md)に関するページ、「[セキュリティに関するデータの考慮事項](security-considerations-for-data.md)」、「[メタデータを使用する場合のセキュリティ上の考慮事項](security-considerations-with-metadata.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="319fd-105">For more information about security, see [Security Considerations](security-considerations-in-wcf.md), [Security Considerations for Data](security-considerations-for-data.md), and [Security Considerations with Metadata](security-considerations-with-metadata.md).</span></span>  
  
## <a name="identify-services-performing-windows-authentication-with-spns"></a><span data-ttu-id="319fd-106">Windows 認証での SPN を使用したサービスの識別</span><span class="sxs-lookup"><span data-stu-id="319fd-106">Identify Services Performing Windows Authentication with SPNs</span></span>  

 <span data-ttu-id="319fd-107">サービスはユーザー プリンシパル名 (UPN) またはサービス プリンシパル名 (SPN) によって識別できます。</span><span class="sxs-lookup"><span data-stu-id="319fd-107">Services can be identified with either user principal names (UPNs) or service principal names (SPNs).</span></span> <span data-ttu-id="319fd-108">ネットワーク サービスのようにコンピューター アカウントを使用して実行するサービスには、サービスが実行されるコンピューターに対応する SPN ID があります。</span><span class="sxs-lookup"><span data-stu-id="319fd-108">Services running under machine accounts such as network service have an SPN identity corresponding to the machine they're running.</span></span> <span data-ttu-id="319fd-109">ユーザー アカウントを使用して実行するサービスには、そのユーザーに対応する UPN ID があります。ただし、`setspn` ツールを使用するとユーザー アカウントに SPN 割り当てることができます。</span><span class="sxs-lookup"><span data-stu-id="319fd-109">Services running under user accounts have a UPN identity corresponding to the user they're running as, although the `setspn` tool can be used to assign an SPN to the user account.</span></span> <span data-ttu-id="319fd-110">サービスが SPN によって識別されるように構成し、サービスに接続するクライアントが SPN を使用してサービスに接続するように構成すると、攻撃の種類によっては攻撃が困難になります。</span><span class="sxs-lookup"><span data-stu-id="319fd-110">Configuring a service so it can be identified via SPN and configuring the clients connecting to the service to use that SPN can make certain attacks more difficult.</span></span> <span data-ttu-id="319fd-111">このガイダンスは Kerberos または SSPI ネゴシエーションを使用するバインディングに適用されます。</span><span class="sxs-lookup"><span data-stu-id="319fd-111">This guidance applies to bindings using Kerberos or SSPI negotiation.</span></span>  <span data-ttu-id="319fd-112">その場合でも、SSPI が使用できなくて NTLM が使用される場合に備えて、クライアントは SPN を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="319fd-112">Clients should still specify an SPN in the case where SSPI falls back to NTLM.</span></span>  
  
## <a name="verify-service-identities-in-wsdl"></a><span data-ttu-id="319fd-113">WSDL でのサービス ID の検証</span><span class="sxs-lookup"><span data-stu-id="319fd-113">Verify Service Identities in WSDL</span></span>  

 <span data-ttu-id="319fd-114">WS-SecurityPolicy ではサービスが自己の ID に関する情報をメタデータの中で公開できるようになっています。</span><span class="sxs-lookup"><span data-stu-id="319fd-114">WS-SecurityPolicy allows services to publish information about their own identities in metadata.</span></span> <span data-ttu-id="319fd-115">この ID 情報は `svcutil` で取得した場合や <xref:System.ServiceModel.Description.WsdlImporter> などその他の方法で取得した場合、WCF サービス エンドポイント アドレスの ID プロパティに変換されます。</span><span class="sxs-lookup"><span data-stu-id="319fd-115">When retrieved via `svcutil` or other methods such as <xref:System.ServiceModel.Description.WsdlImporter>, this identity information is translated to the identity properties of the WCF service endpoint addresses.</span></span> <span data-ttu-id="319fd-116">サービス ID が正しく有効であることを検証しないクライアントは、実質上サービス認証をバイパスすることになります。</span><span class="sxs-lookup"><span data-stu-id="319fd-116">Clients which do not verify that these service identities are correct and valid effectively bypass service authentication.</span></span> <span data-ttu-id="319fd-117">悪意を持ったサービスは、資格情報の転送やその他の "man in the middle" 攻撃を実行するために、その WSDL での ID 宣言を変更することによって、このようなクライアントを利用できます。</span><span class="sxs-lookup"><span data-stu-id="319fd-117">A malicious service can exploit such clients to execute credential forwarding and other "man in the middle" attacks by changing the identity claimed in its WSDL.</span></span>  
  
## <a name="use-x509-certificates-instead-of-ntlm"></a><span data-ttu-id="319fd-118">NTLM の代わりに X509 証明書を使用する</span><span class="sxs-lookup"><span data-stu-id="319fd-118">Use X509 Certificates Instead of NTLM</span></span>  

 <span data-ttu-id="319fd-119">WCF では、ピアツーピア認証用に X509 証明書 (ピア チャネルで使用) と SSPI ネゴシエーションが Kerberos から NTLM にダウングレードされたときに使用される Windows 認証の 2 つのメカニズムが提供されています。</span><span class="sxs-lookup"><span data-stu-id="319fd-119">WCF offers two mechanisms for peer-to-peer authentication: X509 certificates (used by peer channel) and Windows authentication where an SSPI negotiation downgrades from Kerberos to NTLM.</span></span>  <span data-ttu-id="319fd-120">1024 ビット以上のキー サイズを使用する証明書ベースの認証が NTLM より好ましい理由はいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="319fd-120">Certificate-based authentication using key sizes of 1024 bits or more is preferred to NTLM for several reasons:</span></span>  
  
- <span data-ttu-id="319fd-121">相互認証が可能</span><span class="sxs-lookup"><span data-stu-id="319fd-121">the availability of mutual authentication,</span></span>  
  
- <span data-ttu-id="319fd-122">暗号化アルゴリズムの強化</span><span class="sxs-lookup"><span data-stu-id="319fd-122">the use of stronger cryptographic algorithms, and</span></span>  
  
- <span data-ttu-id="319fd-123">転送された X509 資格情報の利用が難しくなる</span><span class="sxs-lookup"><span data-stu-id="319fd-123">the greater difficulty of utilizing forwarded X509 credentials.</span></span>  

## <a name="always-revert-after-impersonation"></a><span data-ttu-id="319fd-124">偽装後は必ず元に戻す</span><span class="sxs-lookup"><span data-stu-id="319fd-124">Always Revert After Impersonation</span></span>  

 <span data-ttu-id="319fd-125">クライアントの偽装を有効にする API を使用した後は、必ず元の ID に戻してください。</span><span class="sxs-lookup"><span data-stu-id="319fd-125">When using APIs that enable impersonation of a client, be sure to revert to the original identity.</span></span> <span data-ttu-id="319fd-126">たとえば、<xref:System.Security.Principal.WindowsIdentity> と <xref:System.Security.Principal.WindowsImpersonationContext> を使用する場合は、次のコードに示すように、C# の `using` ステートメントまたは Visual Basic の `Using` ステートメントを使用します。</span><span class="sxs-lookup"><span data-stu-id="319fd-126">For example, when using the <xref:System.Security.Principal.WindowsIdentity> and <xref:System.Security.Principal.WindowsImpersonationContext>, use the C# `using` statement or the Visual Basic`Using` statement, as shown in the following code.</span></span> <span data-ttu-id="319fd-127"><xref:System.Security.Principal.WindowsImpersonationContext> クラスは <xref:System.IDisposable> インターフェイスを実装しているため、コードが `using` ブロックを抜けると共通言語ランタイム (CLR: Common Language Runtime) は自動的に元の ID に戻ります。</span><span class="sxs-lookup"><span data-stu-id="319fd-127">The <xref:System.Security.Principal.WindowsImpersonationContext> class implements the <xref:System.IDisposable> interface, and therefore the common language runtime (CLR) automatically reverts to the original identity once the code leaves the `using` block.</span></span>  
  
 [!code-csharp[c_SecurityBestPractices#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_securitybestpractices/cs/source.cs#1)]
 [!code-vb[c_SecurityBestPractices#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_securitybestpractices/vb/source.vb#1)]  
  
## <a name="impersonate-only-as-needed"></a><span data-ttu-id="319fd-128">必要な場合のみ偽装を行う</span><span class="sxs-lookup"><span data-stu-id="319fd-128">Impersonate Only as Needed</span></span>  

 <span data-ttu-id="319fd-129"><xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> クラスの <xref:System.Security.Principal.WindowsIdentity> メソッドを使用すると、非常に限られたスコープでしか偽装を使用できなくなります。</span><span class="sxs-lookup"><span data-stu-id="319fd-129">Using the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method of the <xref:System.Security.Principal.WindowsIdentity> class, it is possible to use impersonation in a very controlled scope.</span></span> <span data-ttu-id="319fd-130">これは、操作全体のスコープで偽装が許可される <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> の <xref:System.ServiceModel.OperationBehaviorAttribute> プロパティとは対照的です。</span><span class="sxs-lookup"><span data-stu-id="319fd-130">This is in contrast to using the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute>, which allows impersonation for the scope of the entire operation.</span></span> <span data-ttu-id="319fd-131">可能な限り、<xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> メソッドを使用して偽装のスコープをより厳密に制御します。</span><span class="sxs-lookup"><span data-stu-id="319fd-131">Whenever possible, control the scope of impersonation by using the more precise <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method.</span></span>  
  
## <a name="obtain-metadata-from-trusted-sources"></a><span data-ttu-id="319fd-132">信頼されたソースからメタデータを取得する</span><span class="sxs-lookup"><span data-stu-id="319fd-132">Obtain Metadata from Trusted Sources</span></span>  

 <span data-ttu-id="319fd-133">メタデータのソースが信頼できることと、メタデータが改ざんされていないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="319fd-133">Be sure you trust the source of your metadata and make sure that no one has tampered with the metadata.</span></span> <span data-ttu-id="319fd-134">HTTP プロトコルを使用して取得したメタデータはクリア テキストで送信されるため、改ざんされるおそれがあります。</span><span class="sxs-lookup"><span data-stu-id="319fd-134">Metadata retrieved using the HTTP protocol is sent in clear text and can be tampered with.</span></span> <span data-ttu-id="319fd-135">サービスが <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> および <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> プロパティを使用している場合は、サービス作成者によって提供された URL を使用して HTTPS プロトコルを介してデータをダウンロードします。</span><span class="sxs-lookup"><span data-stu-id="319fd-135">If the service uses the <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> and <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> properties, use the URL supplied by the service creator to download the data using the HTTPS protocol.</span></span>  
  
## <a name="publish-metadata-using-security"></a><span data-ttu-id="319fd-136">セキュリティを使用してメタデータを公開する</span><span class="sxs-lookup"><span data-stu-id="319fd-136">Publish Metadata Using Security</span></span>  

 <span data-ttu-id="319fd-137">サービスが公開したメタデータの改ざんを防ぐには、トランスポート レベルまたはメッセージ レベルのセキュリティを使用して、メタデータ交換エンドポイントをセキュリティで保護します。</span><span class="sxs-lookup"><span data-stu-id="319fd-137">To prevent tampering with a service's published metadata, secure the metadata exchange endpoint with transport or message-level security.</span></span> <span data-ttu-id="319fd-138">詳細については、「[メタデータ エンドポイントを公開する](../publishing-metadata-endpoints.md)」と「[方法 : コードを使用してサービスのメタデータを公開する](how-to-publish-metadata-for-a-service-using-code.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="319fd-138">For more information, see [Publishing Metadata Endpoints](../publishing-metadata-endpoints.md) and [How to: Publish Metadata for a Service Using Code](how-to-publish-metadata-for-a-service-using-code.md).</span></span>  
  
## <a name="ensure-use-of-local-issuer"></a><span data-ttu-id="319fd-139">ローカル発行者の使用を確認する</span><span class="sxs-lookup"><span data-stu-id="319fd-139">Ensure Use of Local Issuer</span></span>  

 <span data-ttu-id="319fd-140">特定のバインディングに対して発行者アドレスとバインディングが指定されている場合、ローカル発行者はこのバインディングを使用するエンドポイントには使用されません。</span><span class="sxs-lookup"><span data-stu-id="319fd-140">If an issuer address and binding are specified for a given binding, the local issuer is not used for endpoints that use that binding.</span></span> <span data-ttu-id="319fd-141">ローカル発行者を常に使用する必要があるクライアントには、このようなバインディングが使用されることがないか、または発行者アドレスが null となるようにクライアントによってバインディングが変更されることが保証されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="319fd-141">Clients who expect to always use the local issuer should ensure that they do not use such a binding or that they modify the binding such that the issuer address is null.</span></span>  
  
## <a name="saml-token-size-quotas"></a><span data-ttu-id="319fd-142">SAML トークン サイズのクォータ</span><span class="sxs-lookup"><span data-stu-id="319fd-142">SAML Token Size Quotas</span></span>  

 <span data-ttu-id="319fd-143">セキュリティ トークン サービス (STS: Security Token Service) によって SAML (Security Assertions Markup Language) トークンが発行されたとき、またはクライアントが認証の一部としてこれをサービスに提示したときに、SAML トークンがメッセージ内にシリアル化される場合は、メッセージの最大クォータ サイズが、SAML トークンおよびメッセージの他の部分を格納できるだけの大きさである必要があります。</span><span class="sxs-lookup"><span data-stu-id="319fd-143">When Security Assertions Markup Language (SAML) tokens are serialized in messages, either when they are issued by a Security Token Service (STS) or when clients present them to services as part of authentication, the maximum message size quota must be sufficiently large to accommodate the SAML token and the other message parts.</span></span> <span data-ttu-id="319fd-144">通常は、既定のメッセージ クォータ サイズで十分です。</span><span class="sxs-lookup"><span data-stu-id="319fd-144">In normal cases, the default message size quotas are sufficient.</span></span> <span data-ttu-id="319fd-145">ただし、数百のクレームを含んでいるために SAML トークンのサイズが大きい場合には、シリアル化されたトークンを格納できるように、クォータを増やす必要があります。</span><span class="sxs-lookup"><span data-stu-id="319fd-145">However, in cases where a SAML token is large because it contains hundreds of claims, the quotas should be increased to accommodate the serialized token.</span></span> <span data-ttu-id="319fd-146">クォータの詳細については、「[セキュリティに関するデータの考慮事項](security-considerations-for-data.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="319fd-146">For more information about quotas, see [Security Considerations for Data](security-considerations-for-data.md).</span></span>  
  
## <a name="set-securitybindingelementincludetimestamp-to-true-on-custom-bindings"></a><span data-ttu-id="319fd-147">カスタム バインディングで SecurityBindingElement.IncludeTimestamp を true に設定する</span><span class="sxs-lookup"><span data-stu-id="319fd-147">Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings</span></span>  

 <span data-ttu-id="319fd-148">カスタム バインドを作成するときは、<xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> を `true` に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="319fd-148">When you create a custom binding, you must set <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> to `true`.</span></span> <span data-ttu-id="319fd-149"><xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> が `false` に設定されている場合に、クライアントが、X509 証明書などの非対称キーに基づくトークンを使用すると、メッセージは署名されません。</span><span class="sxs-lookup"><span data-stu-id="319fd-149">Otherwise, if <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> is set to `false`, and the client is using an asymmetric key-based token such as an X509 certificate, the message will not be signed.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="319fd-150">関連項目</span><span class="sxs-lookup"><span data-stu-id="319fd-150">See also</span></span>

- [<span data-ttu-id="319fd-151">セキュリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="319fd-151">Security Considerations</span></span>](security-considerations-in-wcf.md)
- [<span data-ttu-id="319fd-152">セキュリティに関するデータの考慮事項</span><span class="sxs-lookup"><span data-stu-id="319fd-152">Security Considerations for Data</span></span>](security-considerations-for-data.md)
- [<span data-ttu-id="319fd-153">メタデータを使用する場合のセキュリティ上の考慮事項</span><span class="sxs-lookup"><span data-stu-id="319fd-153">Security Considerations with Metadata</span></span>](security-considerations-with-metadata.md)
