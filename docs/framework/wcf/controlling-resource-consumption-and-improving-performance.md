---
description: '詳細情報: リソース消費の制御とパフォーマンスの向上'
title: リソース消費の制御とパフォーマンスの向上
ms.date: 03/30/2017
ms.assetid: 9a829669-5f76-4c88-80ec-92d0c62c0660
ms.openlocfilehash: df2a2ae8235acecd269644690546098f36bf73c8
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99794456"
---
# <a name="controlling-resource-consumption-and-improving-performance"></a><span data-ttu-id="2438f-103">リソース消費の制御とパフォーマンスの向上</span><span class="sxs-lookup"><span data-stu-id="2438f-103">Controlling Resource Consumption and Improving Performance</span></span>

<span data-ttu-id="2438f-104">このトピックでは、Windows Communication Foundation (WCF) アーキテクチャのさまざまな領域におけるさまざまなプロパティについて説明します。このアーキテクチャでは、リソースの消費量を制御し、パフォーマンスメトリックに影響を与えます。</span><span class="sxs-lookup"><span data-stu-id="2438f-104">This topic describes various properties in different areas of the Windows Communication Foundation (WCF) architecture that work to control resource consumption and affect performance metrics.</span></span>

## <a name="properties-that-constrain-resource-consumption-in-wcf"></a><span data-ttu-id="2438f-105">WCF でのリソース消費を制約するプロパティ</span><span class="sxs-lookup"><span data-stu-id="2438f-105">Properties that Constrain Resource Consumption in WCF</span></span>

 <span data-ttu-id="2438f-106">Windows Communication Foundation (WCF) では、セキュリティとパフォーマンスの両方の目的で、特定の種類のプロセスに制約が適用されます。</span><span class="sxs-lookup"><span data-stu-id="2438f-106">Windows Communication Foundation (WCF) applies constraints on certain types of processes for either security or performance purposes.</span></span> <span data-ttu-id="2438f-107">これらの制約には、クォータとスロットルという 2 つの主要な形式があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-107">These constraints come in two main forms, either quotas and throttles.</span></span> <span data-ttu-id="2438f-108">*クォータ* とは、システム内のある時点で、トリガーが即座に例外になることを示す制限です。</span><span class="sxs-lookup"><span data-stu-id="2438f-108">*Quotas* are limits that when reached or exceeded trigger an immediate exception at some point in the system.</span></span> <span data-ttu-id="2438f-109">*スロットル* とは、すぐに例外がスローされないようにする制限です。</span><span class="sxs-lookup"><span data-stu-id="2438f-109">*Throttles* are limits that do not immediately cause an exception to be thrown.</span></span> <span data-ttu-id="2438f-110">スロットル制限に達すると、例外がスローされる代わりに、そのスロットル値によって設定された制限の範囲内で処理が続行されます。</span><span class="sxs-lookup"><span data-stu-id="2438f-110">Instead, when a throttle limit is reached, processing continues but within the limits set by that throttle value.</span></span> <span data-ttu-id="2438f-111">この制限された処理によって他の場所で例外が発生する可能性がありますが、これはアプリケーションに依存します。</span><span class="sxs-lookup"><span data-stu-id="2438f-111">This limited processing might trigger an exception elsewhere, but this depends upon the application.</span></span>

 <span data-ttu-id="2438f-112">クォータとスロットルの違いに加え、シリアル化レベル、トランスポート レベル、およびアプリケーション レベルにも制約を加えるプロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="2438f-112">In addition to the distinction between quotas and throttles, some constraining properties are located at the serialization level, some at the transport level, and some at the application level.</span></span> <span data-ttu-id="2438f-113">たとえば、システム提供のすべてのトランスポート バインディング要素によって実装されるクォータである <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType> は、既定で 65,536 バイトに設定されます。これは、悪意のあるクライアントがサービスに対して、大量のメモリを消費させるサービス拒否攻撃を実行することを防ぐための措置です </span><span class="sxs-lookup"><span data-stu-id="2438f-113">For example, the quota <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType>, which is implemented by all system-supplied transport binding elements, is set to 65,536 bytes by default to hinder malicious clients from engaging in denial-of-service attacks against a service by causing excessive memory consumption.</span></span> <span data-ttu-id="2438f-114">(通常は、この値を下げることによってパフォーマンスを向上できます)。</span><span class="sxs-lookup"><span data-stu-id="2438f-114">(Typically, you can increase performance by lowering this value.)</span></span>

 <span data-ttu-id="2438f-115">シリアル化のクォータの例としては、<xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> プロパティがあります。このプロパティは、シリアライザーが <xref:System.Runtime.Serialization.DataContractSerializer.ReadObject%2A> メソッドの 1 回の呼び出しでシリアル化または逆シリアル化するオブジェクトの最大数を指定します。</span><span class="sxs-lookup"><span data-stu-id="2438f-115">An example of a serialization quota is the <xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> property, which specifies the maximum number of objects that the serializer serializes or deserializes in a single <xref:System.Runtime.Serialization.DataContractSerializer.ReadObject%2A> method call.</span></span> <span data-ttu-id="2438f-116">アプリケーション レベルのスロットルの例としては、<xref:System.ServiceModel.Dispatcher.ServiceThrottle.MaxConcurrentSessions%2A?displayProperty=nameWithType> プロパティがあります。このプロパティは、既定で、セッションフル チャネルの同時接続の最大数を 10 に制限します </span><span class="sxs-lookup"><span data-stu-id="2438f-116">An example of an application-level throttle is the <xref:System.ServiceModel.Dispatcher.ServiceThrottle.MaxConcurrentSessions%2A?displayProperty=nameWithType> property, which by default restricts the number of concurrent sessionful channel connections to 10.</span></span> <span data-ttu-id="2438f-117">(クォータとは異なり、このスロットル値に達しても、アプリケーションは処理を続行しますが、新しいセッションフル チャネルは受け入れません。つまり、他のセッションフル チャネルのいずれかが終了するまで、新しいクライアントは接続できません)。</span><span class="sxs-lookup"><span data-stu-id="2438f-117">(Unlike the quotas, if this throttle value is reached, the application continues processing but accepts no new sessionful channels, which means that new clients cannot connect until one of the other sessionful channels is ended.)</span></span>

 <span data-ttu-id="2438f-118">これらの制御は、特定の種類の攻撃に対してすぐに使用できる軽減策を提供し、メモリの占有領域や起動時間などのパフォーマンス メトリックを向上するように設計されています。</span><span class="sxs-lookup"><span data-stu-id="2438f-118">These controls are designed to provide an out-of-the-box mitigation against certain types of attacks or to improve performance metrics such as memory footprint, start-up time, and so on.</span></span> <span data-ttu-id="2438f-119">ただし、アプリケーションによっては、これらの制御によってサービス アプリケーションのパフォーマンスが低下したり、アプリケーションがまったく動作しなくなったりする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-119">However, depending on the application, these controls can impede service application performance or prevent the application from working at all.</span></span> <span data-ttu-id="2438f-120">たとえば、ビデオ ストリーミング用に設計されたアプリケーションは、既定の <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType> プロパティをすぐに超える可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-120">For example, an application designed to stream video can easily exceed the default <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="2438f-121">このトピックでは、WCF のすべてのレベルでアプリケーションに適用されるさまざまなコントロールの概要を示し、設定がアプリケーションに妨げられるかどうかに関する詳細情報を取得するさまざまな方法、およびさまざまな問題を修正する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="2438f-121">This topic provides an overview of the various controls applied to applications at all levels of WCF, describes various ways to obtain more information about whether a setting is hindering your application, and describes ways to correct various problems.</span></span> <span data-ttu-id="2438f-122">ほとんどのスロットルおよび一部のクォータは、基本プロパティがシリアル化またはトランスポートの制約である場合でも、アプリケーション レベルで利用できます。</span><span class="sxs-lookup"><span data-stu-id="2438f-122">Most throttles and some quotas are available at the application level, even when the base property is a serialization or transport constraint.</span></span> <span data-ttu-id="2438f-123">たとえば、サービス クラスの <xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> を使用して、<xref:System.ServiceModel.ServiceBehaviorAttribute.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> プロパティを設定できます。</span><span class="sxs-lookup"><span data-stu-id="2438f-123">For example, you can set the <xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> property using the <xref:System.ServiceModel.ServiceBehaviorAttribute.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> property on the service class.</span></span>

> [!NOTE]
> <span data-ttu-id="2438f-124">特定の問題が発生した場合は、まず、 [WCF トラブルシューティングクイックスタート](wcf-troubleshooting-quickstart.md) を読んで、問題 (および解決策) がそこに表示されているかどうかを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-124">If you have a particular problem, you should first read the [WCF Troubleshooting Quickstart](wcf-troubleshooting-quickstart.md) to see whether your problem (and a solution) is listed there.</span></span>

 <span data-ttu-id="2438f-125">シリアル化プロセスを制限するプロパティは、「 [データのセキュリティに関する考慮事項](./feature-details/security-considerations-for-data.md)」に記載されています。</span><span class="sxs-lookup"><span data-stu-id="2438f-125">Properties that restrict serialization processes are listed in [Security Considerations for Data](./feature-details/security-considerations-for-data.md).</span></span> <span data-ttu-id="2438f-126">トランスポートに関連するリソースの消費を制限するプロパティについては、「 [トランスポートクォータ](./feature-details/transport-quotas.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2438f-126">Properties that restrict the consumption of resources related to transports are listed in [Transport Quotas](./feature-details/transport-quotas.md).</span></span> <span data-ttu-id="2438f-127">アプリケーション層でリソースの消費を制限するプロパティは、<xref:System.ServiceModel.Dispatcher.ServiceThrottle> クラスのメンバーです。</span><span class="sxs-lookup"><span data-stu-id="2438f-127">Properties that restrict the consumption of resources at the application layer are the members of the <xref:System.ServiceModel.Dispatcher.ServiceThrottle> class.</span></span>

## <a name="detecting-application-and-performance-issues-related-to-quota-settings"></a><span data-ttu-id="2438f-128">クォータ設定に関連するアプリケーションとパフォーマンスの問題の検出</span><span class="sxs-lookup"><span data-stu-id="2438f-128">Detecting Application and Performance Issues Related to Quota Settings</span></span>

 <span data-ttu-id="2438f-129">上記の値の既定値は、一般的なセキュリティの問題に対する基本的な保護を提供しながら、さまざまなアプリケーションで基本的なアプリケーション機能を使用できるように選択されたものです。</span><span class="sxs-lookup"><span data-stu-id="2438f-129">The defaults of the preceding values have been chosen to enable basic application functionality across a wide range of application types while providing basic protection against common security issues.</span></span> <span data-ttu-id="2438f-130">ただし、アプリケーション デザインによっては、1 つ以上のスロットル設定を超えてしまったためにアプリケーションがセキュリティで保護されなかったり、設計どおりに動作しなかったりする場合があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-130">However, different application designs might exceed one or more throttle settings although the application otherwise is secure and would work as designed.</span></span> <span data-ttu-id="2438f-131">その場合は、超過したスロットル値とそのレベルを特定し、アプリケーションのスループットを向上するための適切な手順を決定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-131">In these cases, you must identify which throttle values are being exceeded and at what level, and decide on the appropriate course of action to increase application throughput.</span></span>

 <span data-ttu-id="2438f-132">通常、アプリケーションを作成してデバッグする際には、構成ファイルまたはプログラムで <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> プロパティを `true` に設定します。</span><span class="sxs-lookup"><span data-stu-id="2438f-132">Typically, when writing the application and debugging it, you set the <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property to `true` in the configuration file or programmatically.</span></span> <span data-ttu-id="2438f-133">これにより、WCF は、サービス例外スタックトレースを表示するためにクライアントアプリケーションに返すように指示します。</span><span class="sxs-lookup"><span data-stu-id="2438f-133">This instructs WCF to return service exception stack traces to the client application for viewing.</span></span> <span data-ttu-id="2438f-134">この機能により、ほとんどのアプリケーション レベルの例外が報告され、問題が発生している場合に、どのクォータ設定が関係しているかを表示できます。</span><span class="sxs-lookup"><span data-stu-id="2438f-134">This feature reports most application-level exceptions in such a way as to display which quota settings might be involved, if that is the problem.</span></span>

 <span data-ttu-id="2438f-135">実行時に発生する一部の例外はアプリケーション層から見えないため、このメカニズムでは返されません。このため、カスタムの <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> 実装で処理できないことがあります。</span><span class="sxs-lookup"><span data-stu-id="2438f-135">Some exceptions happen at run time below the visibility of the application layer and are not returned using this mechanism, and they might not be handled by a custom <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> implementation.</span></span> <span data-ttu-id="2438f-136">Microsoft Visual Studio などの開発環境で作業している場合は、これらの例外のほとんどは自動的に表示されます。</span><span class="sxs-lookup"><span data-stu-id="2438f-136">If you are in a development environment like Microsoft Visual Studio, most of these exceptions are displayed automatically.</span></span> <span data-ttu-id="2438f-137">ただし、一部の例外は、 [マイコードのみ](/visualstudio/debugger/just-my-code) Visual Studio などの開発環境の設定によってマスクされる場合があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-137">However, some exceptions can be masked by development environment settings such as [Just My Code](/visualstudio/debugger/just-my-code) Visual Studio.</span></span>

 <span data-ttu-id="2438f-138">開発環境の機能に関係なく、WCF トレースとメッセージログの機能を使用して、すべての例外をデバッグし、アプリケーションのパフォーマンスを調整することができます。</span><span class="sxs-lookup"><span data-stu-id="2438f-138">Regardless of the capabilities of your development environment, you can use capabilities of WCF tracing and message logging to debug all exceptions and tune the performance of your applications.</span></span> <span data-ttu-id="2438f-139">詳細については、「 [トレースを使用したアプリケーションのトラブルシューティング](./diagnostics/tracing/using-tracing-to-troubleshoot-your-application.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2438f-139">For more information, see [Using Tracing to Troubleshoot Your Application](./diagnostics/tracing/using-tracing-to-troubleshoot-your-application.md).</span></span>

## <a name="performance-issues-and-xmlserializer"></a><span data-ttu-id="2438f-140">パフォーマンスの問題と XmlSerializer</span><span class="sxs-lookup"><span data-stu-id="2438f-140">Performance Issues and XmlSerializer</span></span>

 <span data-ttu-id="2438f-141"><xref:System.Xml.Serialization.XmlSerializer> を使用してシリアル化できるデータ型を使用するサービスおよびクライアント アプリケーションは、実行時にこのようなデータ型のシリアル化コードを生成およびコンパイルします。このため、起動時のパフォーマンスが低下することがあります。</span><span class="sxs-lookup"><span data-stu-id="2438f-141">Services and client applications that use data types that are serializable using the <xref:System.Xml.Serialization.XmlSerializer> generate and compile serialization code for those data types at run time, which can result in slow start-up performance.</span></span>

> [!NOTE]
> <span data-ttu-id="2438f-142">生成済みシリアル化コードはクライアント アプリケーションでのみ使用できます。サービスでは使用できません。</span><span class="sxs-lookup"><span data-stu-id="2438f-142">Pre-generated serialization code can be used only in client applications and not in services.</span></span>

 <span data-ttu-id="2438f-143">[ServiceModel メタデータユーティリティツール (Svcutil.exe)](servicemodel-metadata-utility-tool-svcutil-exe.md)を使用すると、アプリケーションのコンパイル済みアセンブリから必要なシリアル化コードを生成することで、これらのアプリケーションの起動時のパフォーマンスを向上させることができます。</span><span class="sxs-lookup"><span data-stu-id="2438f-143">The [ServiceModel Metadata Utility Tool (Svcutil.exe)](servicemodel-metadata-utility-tool-svcutil-exe.md) can improve start-up performance for these applications by generating the necessary serialization code from the compiled assemblies for the application.</span></span> <span data-ttu-id="2438f-144">詳細については、「 [方法: XmlSerializer を使用して WCF クライアントアプリケーションの起動時間を向上させる](./feature-details/startup-time-of-wcf-client-applications-using-the-xmlserializer.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2438f-144">For more information, see [How to: Improve the Startup Time of WCF Client Applications using the XmlSerializer](./feature-details/startup-time-of-wcf-client-applications-using-the-xmlserializer.md).</span></span>

## <a name="performance-issues-when-hosting-wcf-services-under-aspnet"></a><span data-ttu-id="2438f-145">ASP.NET で WCF サービスをホストする場合のパフォーマンスの問題</span><span class="sxs-lookup"><span data-stu-id="2438f-145">Performance Issues When Hosting WCF Services Under ASP.NET</span></span>

<span data-ttu-id="2438f-146">WCF サービスを IIS および ASP.NET でホストする場合、IIS と ASP.NET の構成設定が WCF サービスのスループットやメモリの占有領域に影響する場合があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-146">When a WCF service is hosted under IIS and ASP.NET, the configuration settings of IIS and ASP.NET can affect the throughput and memory footprint of the WCF service.</span></span>  <span data-ttu-id="2438f-147">ASP.NET のパフォーマンスの詳細については、「 [ASP.NET パフォーマンスの向上](/previous-versions/msp-n-p/ff647787(v=pandp.10))」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2438f-147">For more information about ASP.NET performance, see [Improving ASP.NET Performance](/previous-versions/msp-n-p/ff647787(v=pandp.10)).</span></span> <span data-ttu-id="2438f-148">予想外の結果を引き起こす可能性のある設定の 1 つに、<xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A> があります。これは、<xref:System.Web.Configuration.ProcessModelSection> のプロパティです。</span><span class="sxs-lookup"><span data-stu-id="2438f-148">One setting that might have unintended consequences is <xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A>, which is a property of the <xref:System.Web.Configuration.ProcessModelSection>.</span></span> <span data-ttu-id="2438f-149">アプリケーションのクライアントが固定数または少数である場合、<xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A> を 2 に設定すると、CPU の使用率が 100% に近いマルチプロセッサ コンピューターのスループットが向上する場合があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-149">If your application has a fixed or small number of clients, setting <xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A> to 2 might provide a throughput boost on a multiprocessor machine that has a CPU utilization close to 100%.</span></span> <span data-ttu-id="2438f-150">このパフォーマンスの向上にはコストが伴います。つまり、メモリの使用率も増加するため、スケーラビリティが低下する場合があります。</span><span class="sxs-lookup"><span data-stu-id="2438f-150">This increase in performance comes with a cost: it will also cause an increase in memory usage, which could reduce scalability.</span></span>

## <a name="see-also"></a><span data-ttu-id="2438f-151">関連項目</span><span class="sxs-lookup"><span data-stu-id="2438f-151">See also</span></span>

- [<span data-ttu-id="2438f-152">管理と診断</span><span class="sxs-lookup"><span data-stu-id="2438f-152">Administration and Diagnostics</span></span>](./diagnostics/index.md)
- [<span data-ttu-id="2438f-153">大規模データとストリーミング</span><span class="sxs-lookup"><span data-stu-id="2438f-153">Large Data and Streaming</span></span>](./feature-details/large-data-and-streaming.md)
